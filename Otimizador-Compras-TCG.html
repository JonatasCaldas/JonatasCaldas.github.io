<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Cartas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        /* Estilização customizada para o slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            background: #4a5568;
            height: 0.5rem;
            border-radius: 0.5rem;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -6px; /* Centraliza o thumb na track */
            background-color: #22d3ee;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 50%;
        }
        input[type=range]::-moz-range-track {
            background: #4a5568;
            height: 0.5rem;
            border-radius: 0.5rem;
        }
        input[type=range]::-moz-range-thumb {
            border: none;
            background-color: #22d3ee;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 50%;
        }
        input[type=radio]:checked, input[type=checkbox]:checked {
             box-shadow: 0 0 0 4px #1e293b;
        }
        .tab-btn.active {
            background-color: #22d3ee;
            color: #1a202c;
        }
        .modal-tab-btn.active {
            border-color: #22d3ee;
            color: #22d3ee;
        }

    </style>
</head>
<body class="bg-gray-900 text-white flex items-start justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- Cabeçalho -->
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Otimizador de Compras</h1>
            <p class="text-gray-400 mt-2">Gerencie, classifique e otimize a compra de suas cartas.</p>
        </div>
        
        <!-- Navegação das Abas -->
        <div class="flex border-b border-gray-700 flex-wrap">
            <button id="tab-gerenciador" class="tab-btn active py-2 px-4 font-semibold rounded-t-lg transition-colors duration-300">Atualizar</button>
            <button id="tab-classificador" class="tab-btn py-2 px-4 font-semibold rounded-t-lg transition-colors duration-300 text-gray-400">Gerenciar</button>
            <button id="tab-otimizador" class="tab-btn py-2 px-4 font-semibold rounded-t-lg transition-colors duration-300 text-gray-400">Otimizar</button>
            <button id="tab-dashboard" class="tab-btn py-2 px-4 font-semibold rounded-t-lg transition-colors duration-300 text-gray-400">Dashboard</button>
        </div>

        <!-- Conteúdo das Abas -->
        <div id="tab-content">
            <!-- Gerenciador de Listas -->
            <div id="gerenciador-view" class="space-y-6">
                <div class="text-center">
                    <p class="text-gray-300">Comece por aqui. Insira os dados das suas listas de cartas e salve para continuar.</p>
                </div>
                <div>
                    <div class="flex flex-wrap items-center gap-4">
                        <button id="gravarBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                            Salvar Listas
                        </button>
                        <button id="goToClassifierBtn" class="hidden ml-auto bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                            Ir para o Classificador →
                        </button>
                    </div>
                    <p id="save-feedback" class="text-green-400 h-6 mt-2"></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Coluna PROMO -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg text-cyan-400">Lista PROMO</h3>
                        </div>
                        <textarea id="gerenciador-promo-texto" rows="8" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Cole os dados aqui ou use o botão de upload."></textarea>
                        <label for="upload-promo" class="w-full text-center cursor-pointer bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 block">
                            Upload Promo CSV
                        </label>
                        <input type="file" id="upload-promo" class="hidden" accept=".csv, .txt">
                        <div id="tabela-promo-container" class="overflow-x-auto"></div>
                    </div>
                    <!-- Coluna REGULARES -->
                     <div class="space-y-4">
                         <h3 class="font-bold text-lg text-cyan-400">Lista REGULARES</h3>
                        <textarea id="gerenciador-regulares-texto" rows="8" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Cole os dados aqui ou use o botão de upload."></textarea>
                         <label for="upload-regulares" class="w-full text-center cursor-pointer bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 block">
                            Upload Regulares CSV
                        </label>
                        <input type="file" id="upload-regulares" class="hidden" accept=".csv, .txt">
                        <div id="tabela-regulares-container" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>
            
            <!-- Classificador e Priorizador -->
            <div id="classificador-view" class="hidden space-y-6">
                 <!-- Seção 1: Analisar Nova Carta -->
                <div class="bg-gray-700/50 p-4 rounded-lg">
                    <h3 class="font-bold text-lg text-cyan-400 mb-3">Adicionar Nova Carta</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="card-nome" class="font-semibold text-gray-300 text-sm">Nome do Card</label>
                            <input type="text" id="card-nome" class="w-full mt-1 p-2 bg-gray-600 border border-gray-500 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ex: Charizard ex">
                        </div>
                         <div>
                            <label for="card-valor" class="font-semibold text-gray-300 text-sm">Valor (R$)</label>
                            <input type="number" id="card-valor" class="w-full mt-1 p-2 bg-gray-600 border border-gray-500 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ex: 150.00">
                        </div>
                         <div>
                            <label for="card-lancamento" class="font-semibold text-gray-300 text-sm">Lançamento</label>
                            <input type="text" id="card-lancamento" class="w-full mt-1 p-2 bg-gray-600 border border-gray-500 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="dd/mm/aaaa">
                        </div>
                        <div>
                             <label for="card-popularidade" class="font-semibold text-gray-300 text-sm">Popularidade</label>
                            <div class="flex items-center space-x-4 mt-1">
                                <input type="range" id="card-popularidade" value="2" min="1" max="3" step="1" class="w-full">
                                <span id="popularidade-valor" class="font-semibold text-cyan-400 w-32 text-center">Popular</span>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label for="valor-referencia" class="font-semibold text-gray-300 text-sm">Valor de Referência para Classificação (R$)</label>
                            <input type="number" id="valor-referencia" class="w-full mt-1 p-2 bg-gray-600 border border-gray-500 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ex: 60.00">
                        </div>
                         <div class="md:col-span-2">
                            <div class="flex items-center mt-2">
                                <input id="card-quarentena" type="checkbox" class="h-5 w-5 cursor-pointer appearance-none rounded-full border-2 border-gray-500 bg-gray-600 checked:bg-cyan-500 checked:border-cyan-400 transition-all duration-200">
                                <label for="card-quarentena" class="ml-2 font-medium text-gray-300 cursor-pointer">Quarentena</label>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-4 mt-4">
                        <button id="gerarListaBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                            Adicionar Nova Carta
                        </button>
                        <button id="analisarListaAtualBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                            Atualizar Lista Atual
                        </button>
                        <button id="salvarClassificadaBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                            Salvar
                        </button>
                        <button id="exportClassificadaBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-5 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                            Exportar
                        </button>
                    </div>
                    <p id="classifier-feedback" class="text-green-400 h-6 mt-2"></p>
                </div>

                <!-- Seção 2: Resultado -->
                <div class="bg-gray-700/50 p-4 rounded-lg">
                     <h3 class="font-bold text-lg text-cyan-400 mb-3">Lista Atualizada</h3>
                     <div id="tabela-integrada-container" class="overflow-x-auto">
                        <!-- A tabela será inserida aqui -->
                     </div>
                     <div id="classifier-actions" class="mt-6 text-center"></div>
                </div>
            </div>

            <!-- Otimizador de Compras -->
            <div id="otimizador-view" class="hidden">
                <div class="grid grid-cols-1">
                    <!-- Coluna de Campos de Controle -->
                    <div class="flex flex-col space-y-4 max-w-md mx-auto w-full">
                        <div>
                            <label for="orcamento" class="font-semibold text-gray-300">ORÇAMENTO (R$)</label>
                            <input type="number" id="orcamento" class="w-full p-3 mt-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all duration-300 placeholder-gray-500" placeholder="Ex: 200">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label for="tolerancia" class="font-semibold text-gray-300">TOLERÂNCIA (%)</label>
                                <span id="tolerancia-em-reais" class="text-green-400 font-semibold text-sm"></span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <input type="range" id="tolerancia" value="0" min="0" max="100" class="w-full">
                                <span id="tolerancia-valor" class="font-semibold text-cyan-400 w-12 text-right">0%</span>
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-300 block mb-3">PRIORIDADE (para a lista PROMO)</label>
                            <div class="flex items-center justify-around p-2 bg-gray-700 rounded-lg">
                                <div class="flex items-center" title="Prioridade 1">
                                    <input id="prio-1" name="prioridade" type="radio" value="1" checked class="h-5 w-5 cursor-pointer appearance-none rounded-full border-2 border-gray-500 bg-gray-600 checked:bg-cyan-500 checked:border-cyan-400 transition-all duration-200">
                                    <label for="prio-1" class="ml-2 font-medium text-gray-300 cursor-pointer">1</label>
                                </div>
                                 <div class="flex items-center" title="Prioridade 2">
                                    <input id="prio-2" name="prioridade" type="radio" value="2" class="h-5 w-5 cursor-pointer appearance-none rounded-full border-2 border-gray-500 bg-gray-600 checked:bg-cyan-500 checked:border-cyan-400 transition-all duration-200">
                                    <label for="prio-2" class="ml-2 font-medium text-gray-300 cursor-pointer">2</label>
                                </div>
                                 <div class="flex items-center" title="Prioridade 3">
                                    <input id="prio-3" name="prioridade" type="radio" value="3" class="h-5 w-5 cursor-pointer appearance-none rounded-full border-2 border-gray-500 bg-gray-600 checked:bg-cyan-500 checked:border-cyan-400 transition-all duration-200">
                                    <label for="prio-3" class="ml-2 font-medium text-gray-300 cursor-pointer">3</label>
                                </div>
                                 <div class="flex items-center" title="Prioridade 4">
                                    <input id="prio-4" name="prioridade" type="radio" value="4" class="h-5 w-5 cursor-pointer appearance-none rounded-full border-2 border-gray-500 bg-gray-600 checked:bg-cyan-500 checked:border-cyan-400 transition-all duration-200">
                                    <label for="prio-4" class="ml-2 font-medium text-gray-300 cursor-pointer">4</label>
                                </div>
                                 <div class="flex items-center" title="Prioridade 5">
                                    <input id="prio-5" name="prioridade" type="radio" value="5" class="h-5 w-5 cursor-pointer appearance-none rounded-full border-2 border-gray-500 bg-gray-600 checked:bg-cyan-500 checked:border-cyan-400 transition-all duration-200">
                                    <label for="prio-5" class="ml-2 font-medium text-gray-300 cursor-pointer">5</label>
                                </div>
                            </div>
                        </div>
                        <button id="analisarBtn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg mt-auto">
                            Analisar Compras
                        </button>
                    </div>
                </div>
                 <div id="resultado-otimizador" class="pt-6 border-t border-gray-700 mt-6"></div>
                 <div id="optimizer-actions" class="hidden mt-6 flex flex-col sm:flex-row gap-4 justify-center"></div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard-view" class="hidden space-y-8">
                <!-- Indicadores -->
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 text-center">
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h4 class="text-sm text-gray-400 font-semibold">Valor Total</h4>
                        <p id="db-valor-total" class="text-2xl font-bold text-cyan-400">R$ 0,00</p>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h4 class="text-sm text-gray-400 font-semibold">Total Investido</h4>
                        <p id="db-total-investido" class="text-2xl font-bold text-green-400">R$ 0,00</p>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h4 class="text-sm text-gray-400 font-semibold">Total de Cartas</h4>
                        <p id="db-total-cartas" class="text-2xl font-bold text-white">0</p>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h4 class="text-sm text-gray-400 font-semibold">Cartas Compradas</h4>
                        <p id="db-cartas-compradas" class="text-2xl font-bold text-white">0</p>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h4 class="text-sm text-gray-400 font-semibold">Cartas Faltantes</h4>
                        <p id="db-cartas-faltantes" class="text-2xl font-bold text-white">0</p>
                    </div>
                </div>
                <!-- Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-gray-700/50 p-4 rounded-lg flex flex-col items-center">
                        <h4 class="font-semibold text-gray-300 mb-4">Status da Coleção</h4>
                        <div class="w-full max-w-[250px] mx-auto">
                            <canvas id="status-chart"></canvas>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-gray-700/50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-300 mb-4">Distribuição por Grupo</h4>
                        <canvas id="group-chart"></canvas>
                    </div>
                    <div class="lg:col-span-3 bg-gray-700/50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-300 mb-4">Distribuição por Ano</h4>
                        <canvas id="year-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-6xl max-h-[90vh] flex gap-6">
            <!-- Coluna da Imagem Esquerda -->
            <div class="w-1/3 flex-shrink-0">
                <div class="w-full aspect-[2.5/3.5] bg-gray-700 rounded-lg overflow-hidden flex items-center justify-center sticky top-6">
                    <img id="modal-image-preview" src="https://placehold.co/200x280/2d3748/718096?text=Sem+Imagem" alt="Prévia do card" class="w-full h-full object-contain">
                </div>
            </div>

            <!-- Coluna de Conteúdo Direita -->
            <div class="w-2/3 flex flex-col">
                <!-- Cabeçalho do Modal -->
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-grow">
                        <input id="modal-card-name" type="text" class="text-3xl font-bold bg-transparent border-0 border-b-2 border-gray-700 focus:border-cyan-400 focus:ring-0 w-full text-white p-0" placeholder="Nome do Card">
                        <div class="flex items-center mt-2">
                             <span class="mr-2 text-gray-400 text-sm">Edição:</span>
                             <input id="modal-card-edition" type="text" class="text-sm font-semibold bg-transparent border-0 border-b border-gray-600 focus:border-cyan-400 focus:ring-0 w-auto text-gray-300 p-0" placeholder="Nome da Edição">
                             <span class="mx-2 text-gray-500">|</span>
                             <span class="mr-2 text-gray-400 text-sm">Nº:</span>
                             <input id="modal-card-number" type="text" class="text-sm font-semibold bg-transparent border-0 border-b border-gray-600 focus:border-cyan-400 focus:ring-0 w-24 text-gray-300 p-0" placeholder="000/000">
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0 ml-4">
                        <button id="save-modal-changes" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Salvar</button>
                        <button id="delete-modal-item" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Excluir</button>
                        <button id="close-modal" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Fechar</button>
                    </div>
                </div>

                <!-- Abas do Modal -->
                <div class="flex border-b border-gray-700 mb-4">
                    <button class="modal-tab-btn active text-lg font-semibold py-2 px-4 border-b-2 transition-colors duration-300" data-tab="info">Info</button>
                    <button class="modal-tab-btn text-lg font-semibold py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition-colors duration-300" data-tab="produto">Produto</button>
                </div>

                <!-- Conteúdo das Abas -->
                <div id="modal-tab-content" class="flex-grow overflow-y-auto pr-2">
                    <!-- Aba Info -->
                    <div id="modal-info-tab">
                        <!-- Conteúdo dinâmico será injetado aqui -->
                    </div>
                    <!-- Aba Produto -->
                    <div id="modal-produto-tab" class="hidden">
                         <div class="flex flex-col items-center gap-4">
                            <h3 class="text-lg font-semibold text-gray-300">Imagem do Produto</h3>
                            <div class="w-full max-w-sm aspect-square bg-gray-700 rounded-lg overflow-hidden flex items-center justify-center">
                                 <img id="modal-product-image-preview" src="https://placehold.co/400x400/2d3748/718096?text=Sem+Imagem" alt="Prévia do produto" class="w-full h-full object-contain">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Variáveis Globais ---
        let lastGeneratedList = [];
        let promoDataArray = [];
        let regularesDataArray = [];
        let currentlyEditingIndex = -1;
        let chartInstances = {};

        // --- Lógica das Abas ---
        const tabOtimizadorBtn = document.getElementById('tab-otimizador');
        const tabClassificadorBtn = document.getElementById('tab-classificador');
        const tabGerenciadorBtn = document.getElementById('tab-gerenciador');
        const tabDashboardBtn = document.getElementById('tab-dashboard');
        
        const otimizadorView = document.getElementById('otimizador-view');
        const classificadorView = document.getElementById('classificador-view');
        const gerenciadorView = document.getElementById('gerenciador-view');
        const dashboardView = document.getElementById('dashboard-view');

        const allViews = [otimizadorView, classificadorView, gerenciadorView, dashboardView];
        const allTabs = [tabOtimizadorBtn, tabClassificadorBtn, tabGerenciadorBtn, tabDashboardBtn];

        function switchTab(viewToShow, tabToActivate) {
            allViews.forEach(view => view.classList.add('hidden'));
            allTabs.forEach(tab => {
                tab.classList.remove('active', 'text-gray-900');
                tab.classList.add('text-gray-400');
            });
            
            viewToShow.classList.remove('hidden');
            tabToActivate.classList.add('active', 'text-gray-900');
            tabToActivate.classList.remove('text-gray-400');
            
            if (viewToShow === dashboardView) {
                updateDashboard();
            }
        }

        tabGerenciadorBtn.addEventListener('click', () => switchTab(gerenciadorView, tabGerenciadorBtn));
        tabClassificadorBtn.addEventListener('click', () => switchTab(classificadorView, tabClassificadorBtn));
        tabOtimizadorBtn.addEventListener('click', () => switchTab(otimizadorView, tabOtimizadorBtn));
        tabDashboardBtn.addEventListener('click', () => switchTab(dashboardView, tabDashboardBtn));

        // --- Funções Utilitárias ---
        function smartSplit(line) {
            const cleanItem = (item) => {
                let s = item.trim();
                // Remove quotes only if they are at the very start and end of the item
                if (s.length >= 2 && s.startsWith('"') && s.endsWith('"')) {
                    s = s.substring(1, s.length - 1);
                }
                // Also handle CSVs where quotes are escaped by doubling them (e.g., "a ""b"" c" -> a "b" c)
                return s.replace(/""/g, '"');
            };

            // This handles both comma-separated and tab-separated data that has been re-saved by Excel, which might quote fields.
            if (line.includes('\t')) {
                return line.split('\t').map(cleanItem);
            }
            
            // For pure CSV, split by comma respecting quotes, then clean each part
            return line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cleanItem);
        }

        function parseCurrency(valorString) {
            if (!valorString) return 0;
            const valorLimpo = String(valorString).replace(/"/g, '').replace('R$', '').trim().replace('.', '').replace(',', '.');
            return parseFloat(valorLimpo);
        }
        
        function formatCurrency(valor) {
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function objectArrayToText(data, useComma = false) {
             if (!data || data.length === 0) return "";
             const separator = useComma ? ',' : '\t';
             const headers = Object.keys(data[0]);
             
             const escapeField = (field) => {
                const str = String(field || '');
                if (useComma && (str.includes(',') || str.includes('"') || str.includes('\n'))) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
             };

             const headerLine = headers.map(escapeField).join(separator);
             const lines = data.map(row => headers.map(header => escapeField(row[header])).join(separator));
             return [headerLine, ...lines].join('\n');
        }

        // --- Lógica do Otimizador ---
        const toleranciaSlider = document.getElementById('tolerancia');
        const toleranciaValor = document.getElementById('tolerancia-valor');
        const orcamentoInput = document.getElementById('orcamento');
        const toleranciaReais = document.getElementById('tolerancia-em-reais');

        function atualizarDisplayTolerancia() {
            const orcamento = parseFloat(orcamentoInput.value) || 0;
            const tolerancia = parseInt(toleranciaSlider.value, 10);
            toleranciaValor.textContent = `${tolerancia}%`;

            if (orcamento > 0 && tolerancia > 0) {
                const valorAdicional = (orcamento * tolerancia) / 100;
                toleranciaReais.textContent = `+${formatCurrency(valorAdicional)}`;
            } else {
                toleranciaReais.textContent = '';
            }
        }

        toleranciaSlider.addEventListener('input', atualizarDisplayTolerancia);
        orcamentoInput.addEventListener('input', atualizarDisplayTolerancia);
        
        function showOptimizerActions() {
            const actionsDiv = document.getElementById('optimizer-actions');
            actionsDiv.innerHTML = `
                <button id="adjustListBtn" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Ajustar Lista e Reanalisar</button>
                <button id="newOptimizationBtn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Iniciar Nova Otimização</button>
            `;
            actionsDiv.classList.remove('hidden');

            document.getElementById('adjustListBtn').addEventListener('click', () => {
                switchTab(classificadorView, tabClassificadorBtn);
            });
            document.getElementById('newOptimizationBtn').addEventListener('click', () => {
                orcamentoInput.value = '';
                toleranciaSlider.value = '0';
                atualizarDisplayTolerancia();
                document.getElementById('resultado-otimizador').innerHTML = '';
                actionsDiv.classList.add('hidden');
                orcamentoInput.focus();
            });
        }
        
        document.getElementById('analisarBtn').addEventListener('click', () => {
            const orcamento = parseFloat(orcamentoInput.value);
            const tolerancia = parseFloat(toleranciaSlider.value) || 0;
            const prioridade = parseInt(document.querySelector('input[name="prioridade"]:checked').value, 10);
            const resultadoDiv = document.getElementById('resultado-otimizador');
            resultadoDiv.innerHTML = '';
            
            const promoData = objectArrayToText(promoDataArray);
            const regularesData = objectArrayToText(regularesDataArray);
            
            if (!promoData || isNaN(orcamento) || orcamento <= 0 || isNaN(prioridade)) {
                resultadoDiv.innerHTML = `<div class="bg-red-900 border border-red-700 text-red-300 px-4 py-3 rounded-lg"><p class="font-bold">Erro!</p><p>Orçamento e prioridade devem ser preenchidos. Certifique-se de que a lista PROMO foi salva no Gerenciador de Listas.</p></div>`;
                return;
            }

            try {
                const orcamentoComTolerancia = orcamento * (1 + (tolerancia / 100));
                const linhasPromo = promoData.split('\n').filter(Boolean);
                const cabecalhoPromo = smartSplit(linhasPromo[0]);
                const valorIndexP = cabecalhoPromo.findIndex(h => h.toLowerCase().includes('valor med'));
                const cardIndexP = cabecalhoPromo.findIndex(h => h.toLowerCase().trim() === 'card');
                const prioridadeIndexP = cabecalhoPromo.findIndex(h => h.toLowerCase().includes('prioridade'));

                if (valorIndexP === -1 || cardIndexP === -1 || prioridadeIndexP === -1) throw new Error("Cabeçalho inválido na lista PROMO salva.");

                const dadosCartasPromo = linhasPromo.slice(1).map(linha => parseLinhaOtimizador(linha, valorIndexP, cardIndexP, prioridadeIndexP));
                const cartasPrioritarias = dadosCartasPromo.filter(carta => carta.prioridade === prioridade && carta.valor > 0).sort((a, b) => a.valor - b.valor);

                let orcamentoRestante = orcamentoComTolerancia;
                const { cartasEscolhidas: cartasEscolhidasPromo, custoTotal: custoTotalPromo } = selecionarCartas(cartasPrioritarias, orcamentoRestante);
                orcamentoRestante -= custoTotalPromo;
                
                renderizarResultado(cartasEscolhidasPromo, custoTotalPromo, orcamentoComTolerancia, prioridade, orcamentoRestante);

                if (regularesData && orcamentoRestante > 0) {
                    const linhasRegulares = regularesData.split('\n').filter(Boolean);
                    const cabecalhoRegulares = smartSplit(linhasRegulares[0]);
                    const valorIndexR = cabecalhoRegulares.findIndex(h => h.toLowerCase().includes('valor med') || h.toLowerCase().includes('valor méd liga'));
                    const cardIndexR = cabecalhoRegulares.findIndex(h => h.toLowerCase().trim() === 'card');
                    if (valorIndexR === -1 || cardIndexR === -1) throw new Error("Cabeçalho inválido na lista REGULARES salva.");
                    
                    const dadosCartasRegulares = linhasRegulares.slice(1).map(linha => parseLinhaOtimizador(linha, valorIndexR, cardIndexR, -1));
                    const cartasRegularesCandidatas = dadosCartasRegulares.filter(carta => carta.valor > 0).sort((a, b) => a.valor - b.valor);

                    const { cartasEscolhidas: cartasEscolhidasRegulares, custoTotal: custoTotalRegulares } = selecionarCartas(cartasRegularesCandidatas, orcamentoRestante);
                    renderizarResultadoRegulares(cartasEscolhidasRegulares, custoTotalRegulares, orcamentoRestante);
                }
                
                showOptimizerActions();

            } catch (error) {
                resultadoDiv.innerHTML = `<div class="bg-red-900 border border-red-700 text-red-300 px-4 py-3 rounded-lg"><p class="font-bold">Erro!</p><p>${error.message}</p></div>`;
            }
        });

        function selecionarCartas(listaCartas, orcamento) {
            let custoTotal = 0;
            const cartasEscolhidas = [];
            for (const carta of listaCartas) {
                if (orcamento >= custoTotal + carta.valor) {
                    cartasEscolhidas.push(carta);
                    custoTotal += carta.valor;
                }
            }
            return { cartasEscolhidas, custoTotal };
        }

        function parseLinhaOtimizador(linha, valorIndex, cardIndex, prioridadeIndex) {
            const colunas = smartSplit(linha);
            return {
                nome: colunas[cardIndex] || 'Nome não encontrado',
                prioridade: prioridadeIndex !== -1 && colunas[prioridadeIndex] ? parseInt(colunas[prioridadeIndex], 10) : 0,
                valor: parseCurrency(colunas[valorIndex] || '0')
            };
        }

        function renderizarResultado(cartas, custo, orcamentoAnalisado, prioridade, orcamentoRestante) {
           const resultadoDiv = document.getElementById('resultado-otimizador');
            if (cartas.length === 0) {
                resultadoDiv.innerHTML = `<h2 class="text-2xl font-bold text-yellow-400 mb-4">Análise Concluída (PROMO)</h2><div class="bg-yellow-900 border border-yellow-700 text-yellow-300 p-4 rounded-lg"><p>Nenhuma carta de prioridade ${prioridade} pôde ser comprada com o orçamento de ${formatCurrency(orcamentoAnalisado)} (incluindo tolerância).</p></div>`;
                return;
            }
            const listaHtml = cartas.map(carta => `<li class="flex justify-between items-center p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors duration-200"><span class="font-medium text-gray-200">${carta.nome}</span><span class="font-semibold text-cyan-400">${formatCurrency(carta.valor)}</span></li>`).join('');
            resultadoDiv.innerHTML = `<h2 class="text-2xl font-bold text-cyan-400 mb-4">Cartas Prioritárias Escolhidas</h2><div class="bg-gray-900/50 p-4 rounded-lg"><ul class="space-y-2 mb-4">${listaHtml}</ul><div class="pt-4 border-t border-gray-600 space-y-2 text-right"><p class="text-md text-gray-400">Orçamento Total: <span class="font-semibold">${formatCurrency(orcamentoAnalisado)}</span></p><p class="text-lg">Custo Total (Promo): <span class="font-bold text-green-400">${formatCurrency(custo)}</span></p><p class="text-md text-gray-400">Orçamento Restante: <span class="font-semibold">${formatCurrency(orcamentoRestante)}</span></p></div></div>`;
        }
                
        function renderizarResultadoRegulares(cartas, custo, orcamentoInicial) {
            const resultadoDiv = document.getElementById('resultado-otimizador');
            if (cartas.length === 0) {
                 resultadoDiv.innerHTML += `<div class="bg-gray-700 text-gray-300 p-4 rounded-lg mt-4"><p>Nenhuma carta regular adicional pôde ser comprada com o orçamento restante.</p></div>`;
                 return;
            }
            const listaHtml = cartas.map(carta => `<li class="flex justify-between items-center p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors duration-200"><span class="font-medium text-gray-200">${carta.nome}</span><span class="font-semibold text-cyan-400">${formatCurrency(carta.valor)}</span></li>`).join('');
            const htmlAdicional = `<div class="pt-6 mt-6 border-t-2 border-dashed border-gray-600"><h2 class="text-2xl font-bold text-cyan-400 mb-4">Cartas Regulares Adicionais (Bônus)</h2><div class="bg-gray-900/50 p-4 rounded-lg"><ul class="space-y-2 mb-4">${listaHtml}</ul><div class="pt-4 border-t border-gray-600 space-y-2 text-right"><p class="text-lg">Custo Adicional (Regulares): <span class="font-bold text-green-400">${formatCurrency(custo)}</span></p><p class="text-md text-gray-400">Orçamento Final Restante: <span class="font-semibold">${formatCurrency(orcamentoInicial - custo)}</span></p></div></div>`;
            resultadoDiv.innerHTML += htmlAdicional;
        }

        // --- Lógica do Classificador ---
        const popularidadeSlider = document.getElementById('card-popularidade');
        const popularidadeValor = document.getElementById('popularidade-valor');
        const popMap = { '1': 'Pouco Popular', '2': 'Popular', '3': 'Muito Popular' };
        popularidadeSlider.addEventListener('input', () => {
            popularidadeValor.textContent = popMap[popularidadeSlider.value];
        });

        function processarCarta(cartaObj, valorReferencia) {
            const valor = cartaObj['Valor Med.'] ? parseCurrency(cartaObj['Valor Med.']) : 0;
            cartaObj.valorNumerico = valor;
            const dataLancamento = cartaObj['Lançamento'] || '';
            const ano = dataLancamento.split('/')[2] || new Date().getFullYear();
            
            if (valor > valorReferencia) cartaObj.grupo = 'A';
            else if (valor <= valorReferencia * 0.5) cartaObj.grupo = 'C';
            else cartaObj.grupo = 'B';
            
            const grupoPontos = {'A': 3, 'B': 2, 'C': 1};
            cartaObj.pontoValor = grupoPontos[cartaObj.grupo];

            cartaObj.ano = parseInt(ano);
            const anoAtual = 2025;
            cartaObj.pontoAno = cartaObj.ano < anoAtual ? 2 : 1;
            
            if (cartaObj.pontoPopManual) {
                cartaObj.pontoPop = cartaObj.pontoPopManual;
            } else {
                 const popScore = parseInt(cartaObj['Popularidade'], 10);
                 cartaObj.pontoPop = isNaN(popScore) ? 1 : popScore;
            }

            cartaObj.pontuacaoTotal = cartaObj.pontoValor + cartaObj.pontoAno + cartaObj.pontoPop;
            return cartaObj;
        }

        function runClassifier(listaCompleta, container) {
            const grupoA = listaCompleta.filter(c => c.grupo === 'A');
            const grupoB = listaCompleta.filter(c => c.grupo === 'B');
            const grupoC = listaCompleta.filter(c => c.grupo === 'C');

            const sortFunction = (a, b) => {
                if (b.pontuacaoTotal !== a.pontuacaoTotal) return b.pontuacaoTotal - a.pontuacaoTotal;
                if (b.valorNumerico !== a.valorNumerico) return b.valorNumerico - a.valorNumerico;
                return a.ano - b.ano;
            };

            grupoA.sort(sortFunction).forEach((c, i) => c.prioridadeGrupo = i + 1);
            grupoB.sort(sortFunction).forEach((c, i) => c.prioridadeGrupo = i + 1);
            grupoC.sort(sortFunction).forEach((c, i) => c.prioridadeGrupo = i + 1);
            
            const listaFinal = [...grupoA, ...grupoB, ...grupoC];
            listaFinal.forEach((c, i) => c.rankGeral = i + 1);
            
            lastGeneratedList = listaFinal; // Armazena a lista para importação posterior
            renderizarTabelaIntegrada(listaFinal, container);

            const actionsContainer = document.getElementById('classifier-actions');
            actionsContainer.innerHTML = `<button id="goToOptimizerBtn" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg">Avançar para Otimização →</button>`;
            document.getElementById('goToOptimizerBtn').addEventListener('click', () => {
                switchTab(otimizadorView, tabOtimizadorBtn);
            });
            container.parentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        document.getElementById('gerarListaBtn').addEventListener('click', () => {
            const tabelaContainer = document.getElementById('tabela-integrada-container');
            const nomeInput = document.getElementById('card-nome');
            const valorInput = document.getElementById('card-valor');
            const lancamentoInput = document.getElementById('card-lancamento');
            const quarentenaInput = document.getElementById('card-quarentena');
            const valorReferenciaInput = document.getElementById('valor-referencia');

            const nome = nomeInput.value.trim();
            const valor = valorInput.value; // Get as string to preserve format
            const isQuarantined = quarentenaInput.checked;
            const dataLancamento = lancamentoInput.value.trim();
            const pontoPop = parseInt(popularidadeSlider.value, 10);

            if (!nome || (!isQuarantined && !valor) || !dataLancamento || !valorReferenciaInput.value) {
                tabelaContainer.innerHTML = `<p class="text-red-400 text-center py-4">Por favor, preencha todos os campos da nova carta (Valor é opcional apenas em quarentena).</p>`;
                return;
            }

            try {
                // Determine the headers from existing data or create a default set
                const headerKeys = promoDataArray.length > 0 
                    ? Object.keys(promoDataArray[0]) 
                    : ['Card', 'Valor Med.', 'Lançamento', 'Quarentena', 'Popularidade', 'Foto', 'Foto Produto', 'Bloco', 'Tipo', 'Grupo', 'Prioridade', 'Ano', 'Rank', 'Pontuação', 'Valor Pago', 'Edição', 'Número'];
                
                const newItem = {};
                headerKeys.forEach(key => newItem[key] = ''); // Initialize with empty strings

                // Populate the new item with data from the form
                newItem['Card'] = nome;
                newItem['Valor Med.'] = valor ? `R$ ${parseFloat(valor).toFixed(2).replace('.', ',')}` : 'R$ 0,00';
                newItem['Lançamento'] = dataLancamento;
                newItem['Quarentena'] = isQuarantined ? 'SIM' : 'NAO';
                newItem['Popularidade'] = pontoPop;

                // Add the new item to the main data array
                promoDataArray.push(newItem);

                // Update the manager's textarea to reflect the addition, ensuring save will work
                gerenciadorPromoTexto.value = objectArrayToText(promoDataArray);
                
                // Give feedback to the user
                classifierFeedback.innerHTML = `Item <strong class="text-white">${nome}</strong> adicionado. Clique em <strong class="text-cyan-400">[Salvar]</strong> para salvar permanentemente.`;

                // Automatically run the analysis on the updated list
                document.getElementById('analisarListaAtualBtn').click();
                
                // Clear input fields for the next entry
                nomeInput.value = '';
                valorInput.value = '';
                lancamentoInput.value = '';
                quarentenaInput.checked = false;
                nomeInput.focus();


            } catch (error) {
                tabelaContainer.innerHTML = `<p class="text-red-400">Ocorreu um erro ao adicionar o item: ${error.message}</p>`;
            }
        });
        
        document.getElementById('analisarListaAtualBtn').addEventListener('click', () => {
            const tabelaContainer = document.getElementById('tabela-integrada-container');
            const valorReferencia = parseFloat(document.getElementById('valor-referencia').value);

            if (isNaN(valorReferencia) || valorReferencia <= 0) {
                tabelaContainer.innerHTML = `<p class="text-red-400 text-center py-4">Por favor, preencha o campo "Valor de Referência" para continuar.</p>`;
                return;
            }

            if (promoDataArray.length === 0) {
                tabelaContainer.innerHTML = `<p class="text-red-400 text-center py-4">Sua lista PROMO está vazia. Adicione itens no Gerenciador de Listas primeiro.</p>`;
                return;
            }

            try {
                const listaExistente = JSON.parse(JSON.stringify(promoDataArray)).map((cardObj, index) => {
                    cardObj.originalIndex = index;
                    return processarCarta(cardObj, valorReferencia);
                });
                
                runClassifier(listaExistente, tabelaContainer);

            } catch (error) {
                tabelaContainer.innerHTML = `<p class="text-red-400">Ocorreu um erro ao processar a lista: ${error.message}</p>`;
            }
        });

        function renderizarTabelaIntegrada(cartas, container) {
             if (cartas.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhuma carta para exibir.</p>';
                return;
             }
             const thead = `<thead class="bg-gray-700"><tr><th class="px-4 py-2 text-left">Rank Geral</th><th class="px-4 py-2 text-left">Card</th><th class="px-4 py-2 text-left">Valor</th><th class="px-4 py-2 text-left">Ano</th><th class="px-4 py-2 text-left">Grupo</th><th class="px-4 py-2 text-left">Prioridade (no Grupo)</th><th class="px-4 py-2 text-left">Pontuação</th></tr></thead>`;
             const tbody = cartas.map((carta) => {
                const highlightClass = carta.isNew ? 'bg-cyan-900/60 border-l-4 border-cyan-500' : 'border-b border-gray-700';
                const quarentenaTag = carta.Quarentena === 'SIM' ? `<span class="ml-2 bg-red-600 text-white text-xs font-semibold px-2 py-0.5 rounded-full">Quarentena</span>` : '';
                const isEditable = carta.originalIndex !== undefined;
                const cursorClass = isEditable ? 'cursor-pointer' : '';
                const dataIndexAttr = isEditable ? `data-index="${carta.originalIndex}"` : '';

                return `<tr ${dataIndexAttr} class="${highlightClass} hover:bg-gray-600/50 transition-colors duration-200 ${cursorClass}"><td class="px-4 py-2 font-bold">${carta.rankGeral}</td><td class="px-4 py-2">${carta['Card']}${quarentenaTag}</td><td class="px-4 py-2">${formatCurrency(carta.valorNumerico)}</td><td class="px-4 py-2">${carta.ano}</td><td class="px-4 py-2 font-semibold">${carta.grupo}</td><td class="px-4 py-2 font-bold text-yellow-400">${carta.prioridadeGrupo}</td><td class="px-4 py-2 font-bold text-cyan-400">${carta.pontuacaoTotal}</td></tr>`;
            }).join('');
            container.innerHTML = `<table class="w-full text-sm text-left text-gray-300 rounded-lg overflow-hidden">${thead}<tbody>${tbody}</tbody></table>`;

            // Add event listeners
            container.querySelectorAll('tr[data-index]').forEach(row => {
                row.addEventListener('click', () => {
                    openEditModal(row.dataset.index);
                });
            });
        }

        // --- Lógica do Gerenciador de Listas ---
        const gerenciadorPromoTexto = document.getElementById('gerenciador-promo-texto');
        const gerenciadorRegularesTexto = document.getElementById('gerenciador-regulares-texto');
        const tabelaPromoContainer = document.getElementById('tabela-promo-container');
        const tabelaRegularesContainer = document.getElementById('tabela-regulares-container');
        const saveFeedback = document.getElementById('save-feedback');

        function saveLists(feedbackEl) {
             try {
                // The textareas are kept in sync with the global arrays after edits.
                // We use them as the source of truth for saving to ensure consistency.
                const promoText = gerenciadorPromoTexto.value.trim();
                let parsedPromoData = parseToObjectArray(promoText);
                parsedPromoData.forEach(item => {
                    if (!item.hasOwnProperty('Foto')) item['Foto'] = '';
                    if (!item.hasOwnProperty('Foto Produto')) item['Foto Produto'] = '';
                    if (!item.hasOwnProperty('Quarentena')) item['Quarentena'] = 'NAO';
                    if (!item.hasOwnProperty('Edição')) item['Edição'] = '';
                    if (!item.hasOwnProperty('Número')) item['Número'] = '';
                });
                promoDataArray = parsedPromoData;
                localStorage.setItem('listaPromo', JSON.stringify(promoDataArray));
                renderDataTable(promoDataArray, tabelaPromoContainer);
                
                const regularesText = gerenciadorRegularesTexto.value.trim();
                regularesDataArray = parseToObjectArray(regularesText);
                localStorage.setItem('listaRegulares', JSON.stringify(regularesDataArray));
                renderDataTable(regularesDataArray, tabelaRegularesContainer);

                feedbackEl.innerHTML = '<strong class="text-green-400">Alterações salvas com sucesso!</strong>';
                setTimeout(() => { feedbackEl.innerHTML = '' }, 4000);

                if (feedbackEl.id === 'save-feedback') {
                    document.getElementById('goToClassifierBtn').classList.remove('hidden');
                }
            } catch (error) {
                feedbackEl.textContent = 'Erro ao salvar as listas.';
                console.error("Erro ao salvar no Local Storage:", error);
            }
        }

        document.getElementById('goToClassifierBtn').addEventListener('click', () => {
            switchTab(classificadorView, tabClassificadorBtn);
        });

        // Refactored export logic into a reusable function
        function exportPromoCSV() {
             try {
                const promoData = promoDataArray;
                if (promoData.length === 0) {
                    alert('Não há dados na "Lista PROMO" para exportar. Salve a lista primeiro.');
                    return;
                }
                const csvContent = objectArrayToText(promoData, true); // Use comma for CSV
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "promo_export.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                alert('Ocorreu um erro ao exportar os dados.');
                console.error("Erro na exportação:", error);
            }
        }

        document.getElementById('exportClassificadaBtn').addEventListener('click', exportPromoCSV);

        function parseToObjectArray(text) {
            const lines = text.trim().split('\n').filter(Boolean);
            if (lines.length === 0) return [];
            if (lines.length === 1 && lines[0].split(/[\t,]/).length <= 1) return [];
            
            const cleanedLines = lines.map(line => {
                const trimmed = line.trim();
                if (trimmed.startsWith('"') && trimmed.endsWith('"')) {
                    return trimmed.substring(1, trimmed.length - 1);
                }
                return trimmed;
            });

            const headers = smartSplit(cleanedLines[0]);
            return cleanedLines.slice(1).map(line => {
                const values = smartSplit(line);
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = values[i] || '';
                });
                return obj;
            });
        }
        
        function renderDataTable(data, container) {
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum dado para exibir.</p>';
                return;
            }
            const headers = Object.keys(data[0]);
            const thead = `<thead class="bg-gray-700"><tr>${headers.map(h => `<th class="px-4 py-2 text-left text-sm">${h}</th>`).join('')}</tr></thead>`;
            const tbody = data.map((row, index) => {
                return `
                <tr data-index="${index}" class="border-b border-gray-700 hover:bg-gray-600/50">
                    ${headers.map(h => `<td class="px-4 py-2 text-xs">${row[h] || ''}</td>`).join('')}
                </tr>`;
            }).join('');
            container.innerHTML = `<table class="w-full text-left text-gray-300 rounded-lg overflow-hidden">${thead}<tbody>${tbody}</tbody></table>`;
        }
        
        document.getElementById('gravarBtn').addEventListener('click', () => {
            saveLists(document.getElementById('save-feedback'));
        });

        const classifierFeedback = document.getElementById('classifier-feedback');
        document.getElementById('salvarClassificadaBtn').addEventListener('click', () => {
            if (lastGeneratedList.length > 0) {
                // Atualiza o array de dados principal com os resultados da classificação
                lastGeneratedList.forEach(classifiedItem => {
                    if (classifiedItem.originalIndex !== undefined && promoDataArray[classifiedItem.originalIndex]) {
                        const originalItem = promoDataArray[classifiedItem.originalIndex];
                        originalItem['Grupo'] = classifiedItem.grupo;
                        originalItem['Prioridade'] = classifiedItem.prioridadeGrupo;
                        originalItem['Ano'] = classifiedItem.ano;
                        originalItem['Rank'] = classifiedItem.rankGeral;
                        originalItem['Pontuação'] = classifiedItem.pontuacaoTotal;
                        originalItem['Popularidade'] = classifiedItem.pontoPop;
                    }
                });
                // Atualiza a área de texto para refletir os dados classificados que serão salvos
                gerenciadorPromoTexto.value = objectArrayToText(promoDataArray);
            }
            saveLists(classifierFeedback);
        });

        function setupUpload(inputId, textareaId) {
            document.getElementById(inputId).addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const textarea = document.getElementById(textareaId);
                        textarea.value = e.target.result;
                        textarea.dispatchEvent(new Event('input')); // Trigger input event
                    };
                    reader.readAsText(file);
                }
            });
        }

        setupUpload('upload-promo', 'gerenciador-promo-texto');
        setupUpload('upload-regulares', 'gerenciador-regulares-texto');
        
        // --- Lógica do Modal de Edição ---
        const modal = document.getElementById('edit-modal');
        const infoTab = document.getElementById('modal-info-tab');
        const produtoTab = document.getElementById('modal-produto-tab');

        function setupModalTabs() {
            const tabButtons = modal.querySelectorAll('.modal-tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'text-cyan-400');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-300');
                    });
                    button.classList.add('active', 'text-cyan-400');
                    button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-300');

                    infoTab.classList.toggle('hidden', button.dataset.tab !== 'info');
                    produtoTab.classList.toggle('hidden', button.dataset.tab !== 'produto');
                });
            });
        }

        function openEditModal(index) {
            currentlyEditingIndex = parseInt(index, 10);
            const item = promoDataArray[currentlyEditingIndex];
            if (!item) return;

            // Garante que as novas propriedades existam no objeto
            if (!item.hasOwnProperty('Edição')) item['Edição'] = '';
            if (!item.hasOwnProperty('Número')) item['Número'] = '';
            if (!item.hasOwnProperty('Foto Produto')) item['Foto Produto'] = '';

            // Popula cabeçalho do modal
            document.getElementById('modal-card-name').value = item['Card'] || '';
            document.getElementById('modal-card-edition').value = item['Edição'] || '';
            document.getElementById('modal-card-number').value = item['Número'] || '';

            // Popula imagem do card
            const cardImgPreview = document.getElementById('modal-image-preview');
            const placeholderCardImg = 'https://placehold.co/200x280/2d3748/718096?text=Sem+Imagem';
            cardImgPreview.src = item['Foto'] || placeholderCardImg;
            cardImgPreview.onerror = () => { cardImgPreview.src = placeholderCardImg; };
            
            // Popula imagem do produto
            const productImgPreview = document.getElementById('modal-product-image-preview');
            const placeholderProductImg = 'https://placehold.co/400x400/2d3748/718096?text=Sem+Imagem';
            productImgPreview.src = item['Foto Produto'] || placeholderProductImg;
            productImgPreview.onerror = () => { productImgPreview.src = placeholderProductImg; };


            // Popula dinamicamente a aba "Info" com os campos restantes
            infoTab.innerHTML = '';
            const fieldsToExclude = ['Card', 'Edição', 'Número'];
            const advancedFields = ['Grupo', 'Prioridade', 'Valor Med.', 'Ano', 'Popularidade', 'Quarentena', 'Rank', 'Pontuação'];

            const primaryFieldsContainer = document.createElement('div');
            primaryFieldsContainer.className = 'space-y-4';
            
            const advancedFieldsContainer = document.createElement('div');
            advancedFieldsContainer.className = 'space-y-4 pt-4 mt-4 border-t border-gray-700 hidden';

            const allKeys = Object.keys(item);
            
            // Reorder keys to put advanced fields at the end
            const orderedKeys = allKeys.filter(k => !advancedFields.includes(k)).concat(allKeys.filter(k => advancedFields.includes(k)));

            orderedKeys.forEach(key => {
                if (fieldsToExclude.includes(key)) return;

                const value = item[key];
                const fieldWrapper = document.createElement('div');
                fieldWrapper.className = 'grid grid-cols-3 gap-4 items-center';
                
                const label = document.createElement('label');
                label.htmlFor = `modal-field-${key.replace(/\s/g, '-')}`;
                label.className = 'text-sm font-semibold text-gray-400 col-span-1';
                label.textContent = key;
                fieldWrapper.appendChild(label);

                const input = document.createElement('input');
                input.type = 'text';
                input.id = `modal-field-${key.replace(/\s/g, '-')}`;
                input.dataset.key = key;
                input.value = value;
                input.className = 'col-span-2 w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-cyan-500 focus:border-cyan-500';
                fieldWrapper.appendChild(input);
                
                if (advancedFields.includes(key)) {
                    advancedFieldsContainer.appendChild(fieldWrapper);
                } else {
                    primaryFieldsContainer.appendChild(fieldWrapper);
                }
            });

            infoTab.appendChild(primaryFieldsContainer);
            
            if (advancedFieldsContainer.hasChildNodes()) {
                const toggleButton = document.createElement('button');
                toggleButton.className = 'text-cyan-400 hover:text-cyan-300 font-semibold mt-4 text-sm';
                toggleButton.textContent = 'Ver mais detalhes de análise...';
                toggleButton.onclick = () => {
                    advancedFieldsContainer.classList.toggle('hidden');
                    toggleButton.textContent = advancedFieldsContainer.classList.contains('hidden') 
                        ? 'Ver mais detalhes de análise...' 
                        : 'Ver menos';
                };
                infoTab.appendChild(toggleButton);
            }
            
            infoTab.appendChild(advancedFieldsContainer);

            attachImagePreviewListeners();
            modal.classList.remove('hidden');
        }

        function attachImagePreviewListeners() {
            const cardImgPreview = document.getElementById('modal-image-preview');
            const placeholderCardImg = 'https://placehold.co/200x280/2d3748/718096?text=Sem+Imagem';
            const productImgPreview = document.getElementById('modal-product-image-preview');
            const placeholderProductImg = 'https://placehold.co/400x400/2d3748/718096?text=Sem+Imagem';

            // Listener for Card Photo
            const cardPhotoInput = infoTab.querySelector('input[data-key="Foto"]');
            if (cardPhotoInput) {
                cardPhotoInput.addEventListener('input', (e) => {
                    cardImgPreview.src = e.target.value || placeholderCardImg;
                });
            }

            // Listener for Product Photo
            const productPhotoInput = infoTab.querySelector('input[data-key="Foto Produto"]');
            if (productPhotoInput) {
                productPhotoInput.addEventListener('input', (e) => {
                    productImgPreview.src = e.target.value || placeholderProductImg;
                });
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
            currentlyEditingIndex = -1;
        }

        document.getElementById('close-modal').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        document.getElementById('save-modal-changes').addEventListener('click', () => {
            if (currentlyEditingIndex === -1) return;

            const updatedItem = { ...promoDataArray[currentlyEditingIndex] };

            // Salva campos do cabeçalho
            updatedItem['Card'] = document.getElementById('modal-card-name').value;
            updatedItem['Edição'] = document.getElementById('modal-card-edition').value;
            updatedItem['Número'] = document.getElementById('modal-card-number').value;

            // Salva campos da aba Info
            infoTab.querySelectorAll('input').forEach(input => {
                updatedItem[input.dataset.key] = input.value;
            });

            promoDataArray[currentlyEditingIndex] = updatedItem;
            classifierFeedback.innerHTML = 'Item atualizado. Clique em <strong class="text-cyan-400">[Salvar]</strong> para salvar permanentemente.';

            gerenciadorPromoTexto.value = objectArrayToText(promoDataArray);
            // Re-analisa a lista atual para refletir a mudança
            document.getElementById('analisarListaAtualBtn').click();
            closeModal();
        });

        document.getElementById('delete-modal-item').addEventListener('click', () => {
            if (currentlyEditingIndex === -1) return;

            promoDataArray.splice(currentlyEditingIndex, 1);
            gerenciadorPromoTexto.value = objectArrayToText(promoDataArray);

            classifierFeedback.innerHTML = 'Item removido. Clique em <strong class="text-cyan-400">[Salvar]</strong> para salvar permanentemente.';
            // Re-analisa a lista atual para refletir a remoção
            document.getElementById('analisarListaAtualBtn').click();
            closeModal();
        });
        
        // --- Lógica do Dashboard ---
        function updateDashboard() {
            const data = promoDataArray;

            if (!data || data.length === 0) {
                // Resetar para valores padrão se não houver dados
                document.getElementById('db-valor-total').textContent = formatCurrency(0);
                document.getElementById('db-total-investido').textContent = formatCurrency(0);
                document.getElementById('db-total-cartas').textContent = 0;
                document.getElementById('db-cartas-compradas').textContent = 0;
                document.getElementById('db-cartas-faltantes').textContent = 0;
                // Limpar gráficos
                Object.values(chartInstances).forEach(chart => chart.destroy());
                chartInstances = {};
                return;
            }

            let valorTotal = 0;
            let totalInvestido = 0;
            let cartasCompradas = 0;
            let groupCounts = {};
            const yearCounts = {};

            data.forEach(item => {
                valorTotal += parseCurrency(item['Valor Med.']);
                const valorPago = parseCurrency(item['Valor Pago']);
                if (valorPago > 0) {
                    totalInvestido += valorPago;
                    cartasCompradas++;
                }

                const grupo = item['Grupo'] || 'N/A';
                groupCounts[grupo] = (groupCounts[grupo] || 0) + 1;

                const lancamento = item['Lançamento'] || '';
                const ano = lancamento.split('/')[2] || 'N/A';
                yearCounts[ano] = (yearCounts[ano] || 0) + 1;
            });

            const totalCartas = data.length;
            const cartasFaltantes = totalCartas - cartasCompradas;

            // Update Indicators
            document.getElementById('db-valor-total').textContent = formatCurrency(valorTotal);
            document.getElementById('db-total-investido').textContent = formatCurrency(totalInvestido);
            document.getElementById('db-total-cartas').textContent = totalCartas;
            document.getElementById('db-cartas-compradas').textContent = cartasCompradas;
            document.getElementById('db-cartas-faltantes').textContent = cartasFaltantes;

            // Render Charts
            renderStatusChart(cartasCompradas, cartasFaltantes);
            renderGroupChart(groupCounts);
            renderYearChart(yearCounts);
        }

        function renderChart(chartId, type, data, options) {
            const ctx = document.getElementById(chartId).getContext('2d');
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
            }
            chartInstances[chartId] = new Chart(ctx, { type, data, options });
        }
        
        function renderStatusChart(compradas, faltantes) {
            renderChart('status-chart', 'doughnut', {
                labels: ['Compradas', 'Faltantes'],
                datasets: [{
                    data: [compradas, faltantes],
                    backgroundColor: ['#22d3ee', '#4a5568'],
                    borderColor: '#1f2937',
                    borderWidth: 4
                }]
            }, {
                responsive: true,
                plugins: { legend: { position: 'top', labels: { color: '#e2e8f0' } } }
            });
        }

        function renderGroupChart(groupCounts) {
            const labels = Object.keys(groupCounts).sort();
            const data = labels.map(label => groupCounts[label]);
            renderChart('group-chart', 'bar', {
                labels: labels,
                datasets: [{
                    label: '# de Cartas',
                    data: data,
                    backgroundColor: '#22d3ee',
                    borderColor: '#22d3ee',
                    borderWidth: 1
                }]
            }, {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { ticks: { color: '#e2e8f0', stepSize: 1 } },
                    x: { ticks: { color: '#e2e8f0' } }
                }
            });
        }

        function renderYearChart(yearCounts) {
             const labels = Object.keys(yearCounts).sort((a, b) => a - b);
            const data = labels.map(label => yearCounts[label]);
            renderChart('year-chart', 'line', {
                labels: labels,
                datasets: [{
                    label: '# de Cartas',
                    data: data,
                    backgroundColor: 'rgba(129, 230, 217, 0.2)',
                    borderColor: '#81e6d9',
                    borderWidth: 2,
                    tension: 0.1,
                    pointBackgroundColor: '#81e6d9'
                }]
            }, {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { ticks: { color: '#e2e8f0', stepSize: 1 } },
                    x: { ticks: { color: '#e2e8f0' } }
                }
            });
        }


        // --- Carregar Dados Iniciais ---
        window.addEventListener('load', () => {
            promoDataArray = JSON.parse(localStorage.getItem('listaPromo') || '[]');
            gerenciadorPromoTexto.value = objectArrayToText(promoDataArray);
            renderDataTable(promoDataArray, tabelaPromoContainer);
            
            regularesDataArray = JSON.parse(localStorage.getItem('listaRegulares') || '[]');
            gerenciadorRegularesTexto.value = objectArrayToText(regularesDataArray);
            renderDataTable(regularesDataArray, tabelaRegularesContainer);

            // Inicia na primeira aba e configura o modal
            setupModalTabs();
            switchTab(gerenciadorView, tabGerenciadorBtn);
        });

    </script>
</body>
</html>
