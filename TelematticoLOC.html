<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telemáttico | LOC</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Configuração do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'accent': '#66b2b2',
                        'accent-dark': '#559595',
                        'custom-accent': '#FFE599',
                        'severity-accent': '#6FE6FC', // Cor atualizada para Evolução das Severidades
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        /* Scrollbar fina para a lista de veículos */
        .scrollbar-thin::-webkit-scrollbar {
            width: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body class="text-gray-800 font-sans antialiased min-h-screen flex flex-col items-center pt-12 pb-12">

    <!-- Container Principal -->
    <main class="w-full max-w-5xl px-6">
        
        <!-- Cabeçalho -->
        <header class="mb-8 border-b border-gray-200 pb-4">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Telemáttico LOC 1.4</h1>
            <p class="text-gray-500 mt-1 text-lg">Analise as condições operacionais de cada localidade onde houve um alarme

</p>
        </header>

        <!-- Seção de Entrada -->
        <section class="bg-white p-8 rounded-lg shadow-sm border border-gray-100 mb-6">
            <div class="flex items-end gap-6">
                
                <!-- Input de Arquivo -->
                <div class="flex-grow">
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="csvInput">
                        Selecione o arquivo CSV
                    </label>
                    <input 
                        type="file" 
                        id="csvInput" 
                        accept=".csv"
                        class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-md file:border-0
                            file:text-sm file:font-semibold
                            file:bg-gray-100 file:text-gray-700
                            hover:file:bg-gray-200
                            focus:outline-none cursor-pointer border border-gray-300 rounded-md p-2"
                    >
                </div>

                <!-- Botão de Ação -->
                <button 
                    id="analyzeBtn"
                    class="bg-accent hover:bg-accent-dark text-white font-semibold py-2.5 px-8 rounded-md transition duration-200 shadow-sm flex-shrink-0"
                >
                    Analisar
                </button>
            </div>
        </section>

        <!-- Mensagem de Erro Geral -->
        <div id="errorMessage" class="hidden mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-r shadow-sm">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700" id="errorText">Erro ao processar arquivo.</p>
                </div>
            </div>
        </div>

        <!-- Seção de Saída -->
        <div id="outputContainer" class="hidden space-y-6">
            
            <!-- Título do Local (Site) -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 text-center">
                <h2 id="siteNameDisplay" class="text-2xl font-bold text-gray-800">Nome do Site</h2>
            </div>

            <!-- Painel 1: Cards Totalizadores (Resumo Geral) -->
            <section class="bg-white p-8 rounded-lg shadow-sm border border-gray-100">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 border-l-4 border-accent pl-3">
                    Resumo Geral
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Card 1 -->
                    <div class="bg-gray-50 border border-gray-100 rounded-lg p-6 flex flex-col justify-center items-center text-center">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Maior Detecção</span>
                        <strong id="card1Value" class="text-2xl font-bold text-gray-800 mb-1">-</strong>
                        <span id="card1Label" class="text-sm text-accent font-medium">-</span>
                    </div>
                    <!-- Card 2 -->
                    <div class="bg-gray-50 border border-gray-100 rounded-lg p-6 flex flex-col justify-center items-center text-center">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Maior Severidade</span>
                        <strong id="card2Value" class="text-2xl font-bold text-gray-800 mb-1">-</strong>
                        <span id="card2Label" class="text-sm text-accent font-medium">-</span>
                    </div>
                    <!-- Card 3 -->
                    <div class="bg-gray-50 border border-gray-100 rounded-lg p-6 flex flex-col justify-center items-center text-center">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Maior Velocidade</span>
                        <strong id="card3Value" class="text-2xl font-bold text-gray-800 mb-1">-</strong>
                        <span id="card3Label" class="text-sm text-accent font-medium">-</span>
                    </div>
                    <!-- Card 4 -->
                    <div class="bg-gray-50 border border-gray-100 rounded-lg p-6 flex flex-col items-center text-center">
                        <span id="card4Title" class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Severidades Recentes</span>
                        <div id="card4Container" class="w-full flex flex-col items-center justify-center flex-grow min-h-[60px]">
                            <span class="text-gray-400 text-sm">-</span>
                        </div>
                    </div>
                    
                    <!-- Card 5: Participação de Alarmes -->
                    <div class="bg-gray-50 border border-gray-100 rounded-lg p-6 flex flex-col items-center text-center h-full">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Participação da Composição nos Alarmes</span>
                        <span class="text-[10px] font-bold text-accent uppercase tracking-wide mb-3">últimos 30 dias</span>
                        
                        <!-- Lista de Participação (com scroll se necessário) -->
                        <div id="card5Container" class="w-full flex flex-col items-center justify-start flex-grow overflow-hidden" style="max-height: 120px;">
                            <div id="card5List" class="w-full space-y-1 overflow-y-auto scrollbar-thin pr-1">
                                <span class="text-gray-400 text-sm">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Card 6: Veículo com Maior Severidade Média -->
                    <div class="bg-gray-50 border border-gray-100 rounded-lg p-6 flex flex-col items-center text-center h-full">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Composição com Maior Severidade Média</span>
                        <span class="text-[10px] font-bold text-accent uppercase tracking-wide mb-3">últimos 30 dias</span>
                        
                        <!-- Lista de Média de Severidade -->
                        <div id="card6Container" class="w-full flex flex-col items-center justify-start flex-grow overflow-hidden" style="max-height: 120px;">
                            <div id="card6List" class="w-full space-y-1 overflow-y-auto scrollbar-thin pr-1">
                                <span class="text-gray-400 text-sm">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Painel 2: Evolução Temporal (Padrão) -->
            <section class="bg-white p-8 rounded-lg shadow-sm border border-gray-100">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 border-l-4 border-accent pl-3">
                    Evolução Temporal (Últimos 12 Meses)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="flex flex-col">
                        <div class="flex justify-between items-baseline mb-4">
                            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Média de Velocidade</h3>
                            <span class="text-xs text-gray-400">km/h</span>
                        </div>
                        <div class="chart-container"><canvas id="chartSpeed"></canvas></div>
                    </div>
                    <div class="flex flex-col">
                        <div class="flex justify-between items-baseline mb-4">
                            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Média de Severidade</h3>
                            <span class="text-xs text-gray-400">Pontos</span>
                        </div>
                        <div class="chart-container"><canvas id="chartSeverity"></canvas></div>
                    </div>
                </div>
                <div class="mt-8 pt-8 border-t border-gray-100">
                    <div class="flex flex-col" id="dropOffSection">
                        <div class="flex justify-between items-baseline mb-4">
                            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">DROP-OFF</h3>
                            <span class="text-xs text-gray-400">Eventos</span>
                        </div>
                        <div id="dropOffChartContainer" class="chart-container hidden"><canvas id="chartDropOff"></canvas></div>
                        <div id="dropOffError" class="hidden py-10 bg-gray-50 rounded border border-gray-200 text-center">
                            <p class="text-gray-400 text-sm">Nenhum evento de Drop-off detectado no período analisado.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PAINEL: Evolução Personalizada -->
            <section class="bg-white p-8 rounded-lg shadow-sm border border-gray-100">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 border-l-4 border-custom-accent pl-3">
                    <h2 class="text-xl font-semibold text-gray-800">Evolução Personalizada</h2>
                    <div class="mt-4 md:mt-0 flex items-center gap-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <div class="flex flex-col">
                            <label for="startDate" class="text-[10px] uppercase font-bold text-gray-400">Início</label>
                            <input type="date" id="startDate" class="bg-transparent text-sm font-medium text-gray-700 focus:outline-none cursor-pointer">
                        </div>
                        <span class="text-gray-400">-</span>
                        <div class="flex flex-col">
                            <label for="endDate" class="text-[10px] uppercase font-bold text-gray-400">Fim</label>
                            <input type="date" id="endDate" class="bg-transparent text-sm font-medium text-gray-700 focus:outline-none cursor-pointer">
                        </div>
                    </div>
                </div>
                <div id="customError" class="hidden py-10 bg-red-50 rounded border border-red-100 text-center mb-6">
                    <p id="customErrorText" class="text-red-400 text-sm font-medium">-</p>
                </div>
                <div id="customChartsWrapper">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="flex flex-col">
                            <div class="flex justify-between items-baseline mb-4">
                                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Média de Velocidade</h3>
                                <span class="text-xs text-gray-400">km/h</span>
                            </div>
                            <div class="chart-container"><canvas id="customChartSpeed"></canvas></div>
                        </div>
                        <div class="flex flex-col">
                            <div class="flex justify-between items-baseline mb-4">
                                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Média de Severidade</h3>
                                <span class="text-xs text-gray-400">Pontos</span>
                            </div>
                            <div class="chart-container"><canvas id="customChartSeverity"></canvas></div>
                        </div>
                    </div>
                    <div class="mt-8 pt-8 border-t border-gray-100">
                        <div class="flex flex-col">
                            <div class="flex justify-between items-baseline mb-4">
                                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">DROP-OFF</h3>
                                <span class="text-xs text-gray-400">Eventos</span>
                            </div>
                            <div id="customDropOffChartContainer" class="chart-container">
                                <canvas id="customChartDropOff"></canvas>
                            </div>
                            <!-- Mensagem de erro para drop-off personalizado -->
                            <div id="customDropOffError" class="hidden py-10 bg-gray-50 rounded border border-gray-200 text-center">
                                <p class="text-gray-400 text-sm">Nenhum evento de Drop-off detectado no período analisado.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- NOVO PAINEL: Evolução das Severidades -->
            <section class="bg-white p-8 rounded-lg shadow-sm border border-gray-100">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 border-l-4 border-severity-accent pl-3">
                    <h2 class="text-xl font-semibold text-gray-800">
                        Evolução das Severidades
                    </h2>
                    
                    <!-- Filtro Temporal Severidades -->
                    <div class="mt-4 md:mt-0 flex items-center gap-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <div class="flex flex-col">
                            <label for="sevStartDate" class="text-[10px] uppercase font-bold text-gray-400">Início</label>
                            <input type="date" id="sevStartDate" class="bg-transparent text-sm font-medium text-gray-700 focus:outline-none cursor-pointer">
                        </div>
                        <span class="text-gray-400">-</span>
                        <div class="flex flex-col">
                            <label for="sevEndDate" class="text-[10px] uppercase font-bold text-gray-400">Fim</label>
                            <input type="date" id="sevEndDate" class="bg-transparent text-sm font-medium text-gray-700 focus:outline-none cursor-pointer">
                        </div>
                    </div>
                </div>

                <!-- Mensagem de Erro Severidades -->
                <div id="sevError" class="hidden py-10 bg-red-50 rounded border border-red-100 text-center mb-6">
                    <p id="sevErrorText" class="text-red-400 text-sm font-medium">-</p>
                </div>

                <!-- Container dos Gráficos Severidades -->
                <div id="sevChartsWrapper">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Gráfico 1: Nível 1 -->
                        <div class="flex flex-col">
                            <div class="flex justify-between items-baseline mb-4">
                                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Nível 1 (≥ 4501)</h3>
                                <span class="text-xs text-gray-400">Eventos</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartSevLevel1"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico 2: Nível 2 -->
                        <div class="flex flex-col">
                            <div class="flex justify-between items-baseline mb-4">
                                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Nível 2 (2001 - 4500)</h3>
                                <span class="text-xs text-gray-400">Eventos</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartSevLevel2"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico 3: Nível 3 -->
                        <div class="flex flex-col">
                            <div class="flex justify-between items-baseline mb-4">
                                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Nível 3 (1001 - 2000)</h3>
                                <span class="text-xs text-gray-400">Eventos</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartSevLevel3"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico 4: Nível 4 -->
                        <div class="flex flex-col">
                            <div class="flex justify-between items-baseline mb-4">
                                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Nível 4 (500 - 1000)</h3>
                                <span class="text-xs text-gray-400">Eventos</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartSevLevel4"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Painel 4: Correlações e Tendências -->
            <section class="bg-white p-8 rounded-lg shadow-sm border border-gray-100">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 border-l-4 border-accent pl-3">
                    Correlações e Tendências (Últimos 6 meses)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Divisões de Correlação (Mantidas) -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-5 flex flex-col h-full relative overflow-hidden group hover:border-accent transition-colors duration-200">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <svg class="w-16 h-16 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 cursor-help" title="Este índice vai de 0 a 1, quanto mais próximo de 1 mais correlação há entre velocidade e severidade">Velocidade x Severidade</h3>
                        <div class="flex items-baseline mb-2"><span id="corrValue" class="text-4xl font-bold text-gray-800 tracking-tight">-</span></div>
                        <div class="mt-auto pt-4 border-t border-gray-200"><p id="corrText" class="text-sm text-gray-600 leading-relaxed">-</p></div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-5 flex flex-col h-full relative overflow-hidden group hover:border-accent transition-colors duration-200">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <svg class="w-16 h-16 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        </div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 cursor-help" title="Quanto maior este índice, mais distante está a maior severidade medida pelo trem da média de severidade do site">Composição x Site (Anomalia)</h3>
                        <div class="flex items-baseline mb-2"><span id="zScoreValue" class="text-4xl font-bold text-gray-800 tracking-tight">-</span><span class="ml-2 text-sm text-gray-400 font-medium">Z-Score (σ)</span></div>
                        <div class="mt-auto pt-4 border-t border-gray-200"><p id="zScoreText" class="text-sm text-gray-600 leading-relaxed">-</p></div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-5 flex flex-col h-full relative overflow-hidden group hover:border-accent transition-colors duration-200">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <svg class="w-16 h-16 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        </div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 cursor-help" title="Hora do dia em que ocorrem mais impactos maiores que 2000">Densidade Térmica</h3>
                        <div class="flex items-baseline mb-2"><span id="thermalValue" class="text-4xl font-bold text-gray-800 tracking-tight">-</span></div>
                        <div class="mt-auto pt-4 border-t border-gray-200"><p id="thermalText" class="text-sm text-gray-600 leading-relaxed">-</p></div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-5 flex flex-col h-full relative overflow-hidden group hover:border-accent transition-colors duration-200">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <svg class="w-16 h-16 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 cursor-help" title="Este índice mede a proporção entre a quantidade de veículos diferentes envolvidos em incidentes e o número total de incidentes registrados.">Persistência Geográfica</h3>
                        <div class="flex items-baseline mb-2"><span id="geoValue" class="text-4xl font-bold text-gray-800 tracking-tight">-</span></div>
                        <div class="mt-auto pt-4 border-t border-gray-200"><p id="geoText" class="text-sm text-gray-600 leading-relaxed">-</p></div>
                    </div>
                </div>
            </section>

        </div>

        <!-- Estado Vazio -->
        <div id="emptyState" class="text-center py-20 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">
            <p>Carregue um arquivo e clique em "Analisar" para visualizar os dados.</p>
        </div>

    </main>

    <!-- Lógica da Aplicação -->
    <script>
        // --- Variáveis Globais para Instâncias dos Gráficos ---
        let speedChartInstance = null;
        let severityChartInstance = null;
        let dropOffChartInstance = null;
        
        let customSpeedChartInstance = null;
        let customSeverityChartInstance = null;
        let customDropOffChartInstance = null;

        // Instâncias da Seção Severidades
        let sevLevel1Chart = null;
        let sevLevel2Chart = null;
        let sevLevel3Chart = null;
        let sevLevel4Chart = null;

        // --- Armazenamento Global do CSV ---
        let currentCSVContent = null;

        // --- Constantes de Colunas ---
        const COL = {
            SITE: 'site',
            TIME_PREF: 'time (utc)',
            TIME_FALLBACK: 'time (local)',
            VEHICLE: 'vehicle',
            SPEED: 'speed (km/hr)',
            SEVERITY: 'severity',
            DROP_OFF: 'drop_off_detected'
        };

        // --- Referências do DOM ---
        const elements = {
            input: document.getElementById('csvInput'),
            btn: document.getElementById('analyzeBtn'),
            outputContainer: document.getElementById('outputContainer'),
            emptyState: document.getElementById('emptyState'),
            errorMessage: document.getElementById('errorMessage'),
            errorText: document.getElementById('errorText'),
            siteNameDisplay: document.getElementById('siteNameDisplay'),
            // Cards
            c1Value: document.getElementById('card1Value'),
            c1Label: document.getElementById('card1Label'),
            c2Value: document.getElementById('card2Value'),
            c2Label: document.getElementById('card2Label'),
            c3Value: document.getElementById('card3Value'),
            c3Label: document.getElementById('card3Label'),
            card4Container: document.getElementById('card4Container'),
            card4Title: document.getElementById('card4Title'),
            // Card 5: Participação de Alarmes
            card5List: document.getElementById('card5List'),
            // Card 6: Severidade Média por Veículo
            card6List: document.getElementById('card6List'),
            // Charts Padrão
            chartSpeedCtx: document.getElementById('chartSpeed').getContext('2d'),
            chartSeverityCtx: document.getElementById('chartSeverity').getContext('2d'),
            chartDropOffCtx: document.getElementById('chartDropOff').getContext('2d'),
            dropOffChartContainer: document.getElementById('dropOffChartContainer'),
            dropOffError: document.getElementById('dropOffError'),
            // Custom Section
            startDateInput: document.getElementById('startDate'),
            endDateInput: document.getElementById('endDate'),
            customError: document.getElementById('customError'),
            customErrorText: document.getElementById('customErrorText'),
            customChartsWrapper: document.getElementById('customChartsWrapper'),
            customChartSpeedCtx: document.getElementById('customChartSpeed').getContext('2d'),
            customChartSeverityCtx: document.getElementById('customChartSeverity').getContext('2d'),
            customChartDropOffCtx: document.getElementById('customChartDropOff').getContext('2d'),
            // New Custom DropOff Elements
            customDropOffChartContainer: document.getElementById('customDropOffChartContainer'),
            customDropOffError: document.getElementById('customDropOffError'),
            // Severity Evolution Section
            sevStartDateInput: document.getElementById('sevStartDate'),
            sevEndDateInput: document.getElementById('sevEndDate'),
            sevError: document.getElementById('sevError'),
            sevErrorText: document.getElementById('sevErrorText'),
            sevChartsWrapper: document.getElementById('sevChartsWrapper'),
            chartSevLevel1Ctx: document.getElementById('chartSevLevel1').getContext('2d'),
            chartSevLevel2Ctx: document.getElementById('chartSevLevel2').getContext('2d'),
            chartSevLevel3Ctx: document.getElementById('chartSevLevel3').getContext('2d'),
            chartSevLevel4Ctx: document.getElementById('chartSevLevel4').getContext('2d'),
            // Correlations
            corrValue: document.getElementById('corrValue'),
            corrText: document.getElementById('corrText'),
            zScoreValue: document.getElementById('zScoreValue'),
            zScoreText: document.getElementById('zScoreText'),
            thermalValue: document.getElementById('thermalValue'),
            thermalText: document.getElementById('thermalText'),
            geoValue: document.getElementById('geoValue'),
            geoText: document.getElementById('geoText'),
        };

        // --- Inicialização de Datas ---
        function initDates() {
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - 6);
            
            // Custom Section
            elements.endDateInput.valueAsDate = end;
            elements.startDateInput.valueAsDate = start;

            // Severity Evolution Section
            elements.sevEndDateInput.valueAsDate = end;
            elements.sevStartDateInput.valueAsDate = start;
        }
        initDates();

        // --- Gerenciamento de UI ---
        function resetUI() {
            elements.outputContainer.classList.add('hidden');
            elements.errorMessage.classList.add('hidden');
            elements.emptyState.classList.remove('hidden');
            
            // Destruir gráficos anteriores
            const allCharts = [
                speedChartInstance, severityChartInstance, dropOffChartInstance,
                customSpeedChartInstance, customSeverityChartInstance, customDropOffChartInstance,
                sevLevel1Chart, sevLevel2Chart, sevLevel3Chart, sevLevel4Chart
            ];
            allCharts.forEach(chart => { if(chart) chart.destroy(); });

            // Reset Textos
            elements.siteNameDisplay.textContent = 'Nome do Site';
            elements.corrValue.textContent = '-'; elements.corrText.textContent = '-';
            elements.zScoreValue.textContent = '-'; elements.zScoreText.textContent = '-';
            elements.thermalValue.textContent = '-'; elements.thermalText.textContent = '-';
            elements.geoValue.textContent = '-'; elements.geoText.textContent = '-';
            elements.card4Title.textContent = 'Severidades Recentes';
            elements.card4Container.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
            // Reset Card 5
            elements.card5List.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
            // Reset Card 6
            elements.card6List.innerHTML = '<span class="text-gray-400 text-sm">-</span>';
            
            // Reset Card 3 Label
            elements.c3Value.textContent = '-';
            elements.c3Label.textContent = '-';

            // Reset seções ocultas
            elements.dropOffChartContainer.classList.add('hidden');
            elements.dropOffError.classList.add('hidden');
            elements.customError.classList.add('hidden');
            elements.customChartsWrapper.classList.remove('hidden');
            
            // Reset Custom DropOff specific
            elements.customDropOffChartContainer.classList.add('hidden');
            elements.customDropOffError.classList.add('hidden');

            elements.sevError.classList.add('hidden');
            elements.sevChartsWrapper.classList.remove('hidden');
        }

        function showError(msg) {
            elements.outputContainer.classList.add('hidden');
            elements.emptyState.classList.add('hidden');
            elements.errorMessage.classList.remove('hidden');
            elements.errorText.textContent = msg;
        }

        function showResults() {
            elements.errorMessage.classList.add('hidden');
            elements.emptyState.classList.add('hidden');
            elements.outputContainer.classList.remove('hidden');
        }

        // --- Funções Matemáticas e Parsers ---
        function calculatePearsonCorrelation(x, y) {
            const n = x.length;
            if (n < 2) return 0;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
            const numerator = (n * sumXY) - (sumX * sumY);
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            if (denominator === 0) return 0;
            return numerator / denominator;
        }

        function calculateStandardDeviation(arr) {
            if (arr.length < 2) return 0;
            const mean = arr.reduce((a, b) => a + b) / arr.length;
            const sumSqDiff = arr.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0);
            return Math.sqrt(sumSqDiff / (arr.length - 1));
        }

        function parseCSVLine(line) {
            return line.split(',').map(item => item.trim());
        }

        function renderChart(ctx, label, labels, data, unitSuffix, colorHex) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: colorHex,
                        backgroundColor: colorHex + '1A',
                        borderWidth: 2,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: colorHex,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        if (unitSuffix.includes('km/h')) {
                                            label += context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ' + unitSuffix;
                                        } else if (unitSuffix) {
                                            label += Math.round(context.parsed.y) + ' ' + unitSuffix;
                                        } else {
                                            label += Math.round(context.parsed.y);
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [2, 4], color: '#f3f4f6' },
                            ticks: { font: { size: 11 }, color: '#9ca3af' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 }, color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        // --- Lógica: Evolução das Severidades (NOVA) ---
        function updateSeverityEvolutionSection() {
            if (!currentCSVContent) return;

            // Reset UI
            elements.sevError.classList.add('hidden');
            elements.sevChartsWrapper.classList.remove('hidden');
            
            if (sevLevel1Chart) sevLevel1Chart.destroy();
            if (sevLevel2Chart) sevLevel2Chart.destroy();
            if (sevLevel3Chart) sevLevel3Chart.destroy();
            if (sevLevel4Chart) sevLevel4Chart.destroy();

            // Obter Datas
            const startStr = elements.sevStartDateInput.value;
            const endStr = elements.sevEndDateInput.value;

            if (!startStr || !endStr) return;

            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            const endDateInclusive = new Date(endDate);
            endDateInclusive.setHours(23, 59, 59, 999);
            startDate.setHours(0,0,0,0);

            if (startDate > endDate) {
                elements.sevError.classList.remove('hidden');
                elements.sevErrorText.textContent = "Data inicial não pode ser maior que data final.";
                elements.sevChartsWrapper.classList.add('hidden');
                return;
            }

            // Agregação (Diária vs Mensal)
            const timeDiff = Math.abs(endDateInclusive - startDate);
            const dayDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            const aggregationMode = dayDiff > 31 ? 'monthly' : 'daily';

            // Buckets
            const sevBuckets = new Map();
            const labels = [];
            const displayLabels = [];

            let cursor = new Date(startDate);
            while (cursor <= endDateInclusive) {
                let key, label;
                if (aggregationMode === 'daily') {
                    key = cursor.toISOString().split('T')[0];
                    label = cursor.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    cursor.setDate(cursor.getDate() + 1);
                } else {
                    const year = cursor.getFullYear();
                    const month = String(cursor.getMonth() + 1).padStart(2, '0');
                    key = `${year}-${month}`;
                    label = cursor.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    cursor.setMonth(cursor.getMonth() + 1);
                    cursor.setDate(1);
                }

                if (!sevBuckets.has(key)) {
                    sevBuckets.set(key, { level1: 0, level2: 0, level3: 0, level4: 0 });
                    labels.push(key);
                    displayLabels.push(label);
                }
            }

            // Processar CSV
            const lines = currentCSVContent.split(/\r?\n/).filter(line => line.trim() !== '');
            const headers = parseCSVLine(lines[0].toLowerCase());
            
            let idxTime = headers.indexOf(COL.TIME_PREF.toLowerCase());
            if (idxTime === -1) idxTime = headers.indexOf(COL.TIME_FALLBACK.toLowerCase());
            const idxSeverity = headers.indexOf(COL.SEVERITY.toLowerCase());

            let validRecords = 0;

            for (let i = 1; i < lines.length; i++) {
                const row = parseCSVLine(lines[i]);
                let rawTime = row[idxTime];
                const rawSeverity = row[idxSeverity];

                if (!rawTime || !rawSeverity) continue;
                rawTime = rawTime.replace(/−/g, '-');

                const severity = parseInt(rawSeverity, 10);
                const dateObj = new Date(rawTime);

                // Validações
                if (isNaN(severity) || isNaN(dateObj.getTime())) continue;
                if (severity < 500) continue; // Regra: Ignorar < 500

                // Filtro Temporal
                if (dateObj >= startDate && dateObj <= endDateInclusive) {
                    let key;
                    if (aggregationMode === 'daily') {
                        key = dateObj.toISOString().split('T')[0];
                    } else {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        key = `${year}-${month}`;
                    }

                    if (sevBuckets.has(key)) {
                        validRecords++;
                        const b = sevBuckets.get(key);
                        
                        // Classificação de Níveis
                        if (severity >= 4501) {
                            b.level1++;
                        } else if (severity >= 2001) {
                            b.level2++;
                        } else if (severity >= 1001) {
                            b.level3++;
                        } else if (severity >= 500) {
                            b.level4++;
                        }
                    }
                }
            }

            if (validRecords === 0) {
                elements.sevError.classList.remove('hidden');
                elements.sevErrorText.textContent = "Não existem registros válidos (Severidade >= 500) dentro do intervalo selecionado.";
                elements.sevChartsWrapper.classList.add('hidden');
                return;
            }

            // Preparar Dados
            const l1Data = [], l2Data = [], l3Data = [], l4Data = [];
            labels.forEach(key => {
                const b = sevBuckets.get(key);
                l1Data.push(b.level1);
                l2Data.push(b.level2);
                l3Data.push(b.level3);
                l4Data.push(b.level4);
            });

            const sevColor = '#6FE6FC';
            
            sevLevel1Chart = renderChart(elements.chartSevLevel1Ctx, 'Nível 1', displayLabels, l1Data, '', sevColor);
            sevLevel2Chart = renderChart(elements.chartSevLevel2Ctx, 'Nível 2', displayLabels, l2Data, '', sevColor);
            sevLevel3Chart = renderChart(elements.chartSevLevel3Ctx, 'Nível 3', displayLabels, l3Data, '', sevColor);
            sevLevel4Chart = renderChart(elements.chartSevLevel4Ctx, 'Nível 4', displayLabels, l4Data, '', sevColor);
        }

        // --- Processamento da Seção Customizada (Existente) ---
        function updateCustomSection() {
            if (!currentCSVContent) return;

            elements.customError.classList.add('hidden');
            elements.customChartsWrapper.classList.remove('hidden');
            
            if (customSpeedChartInstance) customSpeedChartInstance.destroy();
            if (customSeverityChartInstance) customSeverityChartInstance.destroy();
            if (customDropOffChartInstance) customDropOffChartInstance.destroy();

            const startStr = elements.startDateInput.value;
            const endStr = elements.endDateInput.value;

            if (!startStr || !endStr) return;

            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            const endDateInclusive = new Date(endDate);
            endDateInclusive.setHours(23, 59, 59, 999);
            startDate.setHours(0,0,0,0);

            if (startDate > endDate) {
                elements.customError.classList.remove('hidden');
                elements.customErrorText.textContent = "Data inicial não pode ser maior que data final.";
                elements.customChartsWrapper.classList.add('hidden');
                return;
            }

            const timeDiff = Math.abs(endDateInclusive - startDate);
            const dayDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            const aggregationMode = dayDiff > 31 ? 'monthly' : 'daily';

            const customBuckets = new Map();
            const labels = [];
            const displayLabels = [];

            let cursor = new Date(startDate);
            while (cursor <= endDateInclusive) {
                let key, label;
                if (aggregationMode === 'daily') {
                    key = cursor.toISOString().split('T')[0];
                    label = cursor.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    cursor.setDate(cursor.getDate() + 1);
                } else {
                    const year = cursor.getFullYear();
                    const month = String(cursor.getMonth() + 1).padStart(2, '0');
                    key = `${year}-${month}`;
                    label = cursor.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    cursor.setMonth(cursor.getMonth() + 1);
                    cursor.setDate(1); 
                }

                if (!customBuckets.has(key)) {
                    customBuckets.set(key, { speedSum: 0, speedCount: 0, sevSum: 0, sevCount: 0, dropOffCount: 0 });
                    labels.push(key);
                    displayLabels.push(label);
                }
            }

            const lines = currentCSVContent.split(/\r?\n/).filter(line => line.trim() !== '');
            const headers = parseCSVLine(lines[0].toLowerCase());
            
            let idxTime = headers.indexOf(COL.TIME_PREF.toLowerCase());
            if (idxTime === -1) idxTime = headers.indexOf(COL.TIME_FALLBACK.toLowerCase());
            const idxSpeed = headers.indexOf(COL.SPEED.toLowerCase());
            const idxSeverity = headers.indexOf(COL.SEVERITY.toLowerCase());
            const idxDropOff = headers.indexOf(COL.DROP_OFF.toLowerCase());

            let validRecordsInInterval = 0;
            let totalDropOffsInInterval = 0; // Track total drop-offs in custom interval

            for (let i = 1; i < lines.length; i++) {
                const row = parseCSVLine(lines[i]);
                let rawTime = row[idxTime];
                const rawSpeed = row[idxSpeed];
                const rawSeverity = row[idxSeverity];
                const rawDropOff = idxDropOff !== -1 ? row[idxDropOff] : null;

                if (!rawTime || !rawSpeed || !rawSeverity) continue;
                rawTime = rawTime.replace(/−/g, '-');

                const speed = parseFloat(rawSpeed);
                const severity = parseInt(rawSeverity, 10);
                const dateObj = new Date(rawTime);

                if (isNaN(speed) || isNaN(severity) || isNaN(dateObj.getTime())) continue;

                if (dateObj >= startDate && dateObj <= endDateInclusive) {
                    let key;
                    if (aggregationMode === 'daily') {
                        key = dateObj.toISOString().split('T')[0];
                    } else {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        key = `${year}-${month}`;
                    }

                    if (customBuckets.has(key)) {
                        validRecordsInInterval++;
                        const bucket = customBuckets.get(key);
                        bucket.speedSum += speed;
                        bucket.speedCount++;
                        bucket.sevSum += severity;
                        bucket.sevCount++;
                        if (rawDropOff && rawDropOff.trim().toLowerCase() === 'true') {
                            bucket.dropOffCount++;
                            totalDropOffsInInterval++;
                        }
                    }
                }
            }

            if (validRecordsInInterval === 0) {
                elements.customError.classList.remove('hidden');
                elements.customErrorText.textContent = "Não existem registros válidos dentro do intervalo selecionado.";
                elements.customChartsWrapper.classList.add('hidden');
                return;
            }

            const speedData = [];
            const sevData = [];
            const dropOffData = [];

            labels.forEach(key => {
                const b = customBuckets.get(key);
                speedData.push(b.speedCount > 0 ? (b.speedSum / b.speedCount) : 0);
                sevData.push(b.sevCount > 0 ? (b.sevSum / b.sevCount) : 0);
                dropOffData.push(b.dropOffCount);
            });

            const customColor = '#FFE599';
            customSpeedChartInstance = renderChart(elements.customChartSpeedCtx, 'Velocidade Média', displayLabels, speedData, 'km/h', customColor);
            customSeverityChartInstance = renderChart(elements.customChartSeverityCtx, 'Severidade Média', displayLabels, sevData, '', customColor);
            
            // Custom Drop-off Logic
            if (totalDropOffsInInterval > 0) {
                elements.customDropOffChartContainer.classList.remove('hidden');
                elements.customDropOffError.classList.add('hidden');
                customDropOffChartInstance = renderChart(elements.customChartDropOffCtx, 'Eventos Drop-off', displayLabels, dropOffData, '', customColor);
            } else {
                elements.customDropOffChartContainer.classList.add('hidden');
                elements.customDropOffError.classList.remove('hidden');
            }
        }

        // --- Processamento Principal ---
        function processData(csvText) {
            currentCSVContent = csvText;
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) { showError("O arquivo CSV está vazio ou contém apenas o cabeçalho."); return; }

            const headers = parseCSVLine(lines[0].toLowerCase());
            const idxSite = headers.indexOf(COL.SITE.toLowerCase());
            let idxTime = headers.indexOf(COL.TIME_PREF.toLowerCase());
            if (idxTime === -1) idxTime = headers.indexOf(COL.TIME_FALLBACK.toLowerCase());
            const idxVehicle = headers.indexOf(COL.VEHICLE.toLowerCase());
            const idxSpeed = headers.indexOf(COL.SPEED.toLowerCase());
            const idxSeverity = headers.indexOf(COL.SEVERITY.toLowerCase());
            const idxDropOff = headers.indexOf(COL.DROP_OFF.toLowerCase());

            if (idxTime === -1 || idxVehicle === -1 || idxSpeed === -1 || idxSeverity === -1) {
                showError("Estrutura do CSV inválida. Colunas obrigatórias não encontradas.");
                return;
            }

            const now = new Date();
            const monthBuckets = new Map();
            const monthLabels = [];
            const displayLabels = [];
            for (let i = 11; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const key = `${year}-${month}`;
                const shortMonth = d.toLocaleString('pt-BR', { month: 'short' });
                const shortYear = year.toString().slice(-2);
                monthBuckets.set(key, { speedSum: 0, speedCount: 0, sevSum: 0, sevCount: 0, dropOffCount: 0 });
                monthLabels.push(key);
                displayLabels.push(`${shortMonth} ${shortYear}`);
            }

            let validRecords = 0;
            let totalSpeed = 0;
            // Variable to track MAX speed instead of just total
            let maxSpeedGlobal = 0;
            let maxSpeedVehicle = "-";

            let validRecordsInWindow = 0;
            const vehicleMap = new Map();
            const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, 1);
            
            const windowSpeeds = [];
            const windowSeverities = [];
            let maxSeverityInWindow = -1;
            let maxSeverityVehicle = null;
            const thermalHourCounts = new Array(24).fill(0);
            let hasSevereImpacts = false;
            const uniqueVehiclesInWindow = new Set();
            let totalEventsInWindow = 0;
            let foundSiteName = null;
            let totalDropOffsInWindow = 0;
            const allValidSeverities = [];

            // Card 5 Variables (Last 30 Days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(now.getDate() - 30);
            thirtyDaysAgo.setHours(0,0,0,0);
            let totalAlarms30d = 0;
            const vehicleCounts30d = {};
            
            // Card 6 Variables (Last 30 Days)
            const vehicleSeverityStats30d = {};

            for (let i = 1; i < lines.length; i++) {
                const row = parseCSVLine(lines[i]);
                let rawTime = row[idxTime];
                const rawVehicle = row[idxVehicle]; // Vehicle name might be empty but we count it
                const rawSpeed = row[idxSpeed];
                const rawSeverity = row[idxSeverity];
                const rawDropOff = idxDropOff !== -1 ? row[idxDropOff] : null;
                
                if (!foundSiteName && idxSite !== -1 && row[idxSite]) foundSiteName = row[idxSite];
                if (!rawTime) continue; // Time is essential
                rawTime = rawTime.replace(/−/g, '-');
                const dateObj = new Date(rawTime);
                const timestamp = dateObj.getTime();
                if (isNaN(timestamp)) continue;

                // Pre-parsing for Card 6 (Card 6 logic below needs to be robust)
                let severity = null;
                if (rawSeverity) severity = parseInt(rawSeverity, 10);

                // --- Card 5 & 6: (Last 30 days) ---
                if (dateObj >= thirtyDaysAgo) {
                    // Card 5
                    totalAlarms30d++;
                    // Use vehicle name or "(Sem ID)" if empty, but consistent
                    const vName = rawVehicle ? rawVehicle : ""; 
                    vehicleCounts30d[vName] = (vehicleCounts30d[vName] || 0) + 1;

                    // Card 6
                    if (severity !== null && !isNaN(severity)) {
                        if (!vehicleSeverityStats30d[vName]) {
                            vehicleSeverityStats30d[vName] = { sum: 0, count: 0 };
                        }
                        vehicleSeverityStats30d[vName].sum += severity;
                        vehicleSeverityStats30d[vName].count += 1;
                    }
                }

                // For other calculations, we strictly need vehicle/speed/severity
                if (!rawVehicle || !rawSpeed || !rawSeverity) continue;

                const speed = parseFloat(rawSpeed);
                // re-parse locally for clarity, though variable 'severity' holds it
                if (severity === null || isNaN(severity)) severity = parseInt(rawSeverity, 10);

                if (isNaN(speed) || isNaN(severity)) continue;

                // Global Stats (Card 1, 2, 3)
                validRecords++;
                totalSpeed += speed;
                
                // Track Max Speed for Card 3
                if (speed > maxSpeedGlobal) {
                    maxSpeedGlobal = speed;
                    maxSpeedVehicle = rawVehicle;
                }

                if (!vehicleMap.has(rawVehicle)) vehicleMap.set(rawVehicle, { id: rawVehicle, count: 0, maxSeverity: 0, lastTime: 0 });
                const vData = vehicleMap.get(rawVehicle);
                vData.count += 1;
                if (severity > vData.maxSeverity) vData.maxSeverity = severity;
                if (timestamp > vData.lastTime) vData.lastTime = timestamp;

                // Card 4 Data
                allValidSeverities.push({ severity: severity, date: dateObj });

                // 12 Months Graph Data
                const recordYear = dateObj.getFullYear();
                const recordMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
                const bucketKey = `${recordYear}-${recordMonth}`;
                if (monthBuckets.has(bucketKey)) {
                    validRecordsInWindow++;
                    const bucket = monthBuckets.get(bucketKey);
                    bucket.speedSum += speed;
                    bucket.speedCount++;
                    bucket.sevSum += severity;
                    bucket.sevCount++;
                    if (rawDropOff && rawDropOff.trim().toLowerCase() === 'true') {
                        bucket.dropOffCount++;
                        totalDropOffsInWindow++;
                    }
                }

                // 6 Months Stats
                if (dateObj >= sixMonthsAgo) {
                    windowSpeeds.push(speed);
                    windowSeverities.push(severity);
                    if (severity > maxSeverityInWindow) {
                        maxSeverityInWindow = severity;
                        maxSeverityVehicle = rawVehicle;
                    }
                    if (severity >= 2000) {
                        const hour = dateObj.getUTCHours();
                        thermalHourCounts[hour]++;
                        hasSevereImpacts = true;
                    }
                    uniqueVehiclesInWindow.add(rawVehicle);
                    totalEventsInWindow++;
                }
            }

            if (validRecords === 0 && totalAlarms30d === 0) { showError("Nenhum registro válido encontrado no arquivo."); return; }
            
            // UI Updates
            if (foundSiteName) elements.siteNameDisplay.textContent = foundSiteName;
            else elements.siteNameDisplay.textContent = 'Site (Nome não detectado)';

            if (validRecords > 0) {
                const vehicles = Array.from(vehicleMap.values());
                const compareWinner = (a, b, property) => {
                    if (a[property] !== b[property]) return b[property] - a[property];
                    return b.lastTime - a.lastTime;
                };
                const topDetection = [...vehicles].sort((a, b) => compareWinner(a, b, 'count'))[0];
                const topSeverity = [...vehicles].sort((a, b) => compareWinner(a, b, 'maxSeverity'))[0];
                const avgSpeedGlobal = totalSpeed / validRecords;

                // Card 1
                elements.c1Value.textContent = topDetection.id;
                elements.c1Label.textContent = `${topDetection.count} detecções`;
                
                // Card 2 (Inverted info)
                elements.c2Value.textContent = topSeverity.maxSeverity; // Big text: Severity
                elements.c2Label.textContent = topSeverity.id; // Small text: Vehicle ID

                // Card 3 (Now Max Speed)
                elements.c3Value.textContent = maxSpeedGlobal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " km/h";
                elements.c3Label.textContent = maxSpeedVehicle; // Show vehicle that achieved it
            }

            // Card 4 Logic
            if (allValidSeverities.length === 0) {
                elements.card4Container.innerHTML = '<p class="text-xs text-gray-400 mt-2">Nenhuma severidade válida encontrada.</p>';
            } else {
                allValidSeverities.sort((a, b) => b.date - a.date);
                const mostRecentDate = allValidSeverities[0].date;
                const mostRecentDateString = mostRecentDate.toDateString();
                const mostRecentDateLabel = mostRecentDate.toLocaleDateString('pt-BR');
                const recentSeverities = allValidSeverities.filter(item => item.date.toDateString() === mostRecentDateString);
                recentSeverities.sort((a, b) => {
                    if (b.severity !== a.severity) return b.severity - a.severity;
                    return b.date - a.date;
                });
                const top3Recent = recentSeverities.slice(0, 3).sort((a, b) => b.date - a.date);
                elements.card4Title.textContent = `Severidades Mais Recentes: ${mostRecentDateLabel}`;
                let html = '<div class="w-full space-y-2 mt-1">';
                top3Recent.forEach(item => {
                    const timeStr = item.date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                    html += `<div class="flex justify-between items-center border-b border-gray-100 pb-1 last:border-0"><span class="text-lg font-bold text-gray-800">${item.severity}</span><div class="text-right leading-tight"><div class="text-[10px] text-gray-500">${mostRecentDateLabel}</div><div class="text-[10px] font-mono text-gray-400">${timeStr}</div></div></div>`;
                });
                html += '</div>';
                elements.card4Container.innerHTML = html;
            }

            // Update Card 5: Participation
            if (totalAlarms30d === 0) {
                elements.card5List.innerHTML = '<p class="text-xs text-gray-400 mt-2">Nenhum alarme nos últimos 30 dias.</p>';
            } else {
                const participationList = [];
                for (const [vName, count] of Object.entries(vehicleCounts30d)) {
                    const percent = (count / totalAlarms30d) * 100;
                    participationList.push({ name: vName, percent: percent });
                }
                // Sort Alphabetically
                participationList.sort((a, b) => a.name.localeCompare(b.name));

                let html5 = '';
                participationList.forEach(item => {
                    const formattedPercent = item.percent.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%';
                    const displayName = item.name === "" ? "(Sem ID)" : item.name;
                    html5 += `<div class="flex justify-between items-center text-xs border-b border-gray-100 last:border-0 py-1">
                        <span class="font-bold text-gray-700">${displayName}:</span>
                        <span class="text-gray-500">${formattedPercent}</span>
                    </div>`;
                });
                elements.card5List.innerHTML = html5;
            }

            // Update Card 6: Average Severity
            if (Object.keys(vehicleSeverityStats30d).length === 0) {
                elements.card6List.innerHTML = '<p class="text-xs text-gray-400 mt-2">Nenhuma severidade válida nos últimos 30 dias.</p>';
            } else {
                const sevAvgList = [];
                for (const [vName, stats] of Object.entries(vehicleSeverityStats30d)) {
                    if (stats.count > 0) {
                        const avg = stats.sum / stats.count;
                        sevAvgList.push({ name: vName, average: avg });
                    }
                }
                // Sort Alphabetically
                sevAvgList.sort((a, b) => a.name.localeCompare(b.name));

                let html6 = '';
                sevAvgList.forEach(item => {
                    const formattedAvg = item.average.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const displayName = item.name === "" ? "(Sem ID)" : item.name;
                    html6 += `<div class="flex justify-between items-center text-xs border-b border-gray-100 last:border-0 py-1">
                        <span class="font-bold text-gray-700">${displayName}:</span>
                        <span class="text-gray-500">${formattedAvg}</span>
                    </div>`;
                });
                elements.card6List.innerHTML = html6;
            }

            // Only update graphs if we have data in window
            if (validRecordsInWindow > 0) {
                // Standard Charts
                const speedData = [], sevData = [], dropOffData = [];
                monthLabels.forEach(key => {
                    const b = monthBuckets.get(key);
                    speedData.push(b.speedCount > 0 ? (b.speedSum / b.speedCount) : 0);
                    sevData.push(b.sevCount > 0 ? (b.sevSum / b.sevCount) : 0);
                    dropOffData.push(b.dropOffCount);
                });

                const defaultColor = '#66b2b2';
                speedChartInstance = renderChart(elements.chartSpeedCtx, 'Velocidade Média', displayLabels, speedData, 'km/h', defaultColor);
                severityChartInstance = renderChart(elements.chartSeverityCtx, 'Severidade Média', displayLabels, sevData, '', defaultColor);
                
                if (totalDropOffsInWindow > 0) {
                    elements.dropOffChartContainer.classList.remove('hidden');
                    elements.dropOffError.classList.add('hidden');
                    dropOffChartInstance = renderChart(elements.chartDropOffCtx, 'Eventos Drop-off', displayLabels, dropOffData, '', defaultColor);
                } else {
                    elements.dropOffChartContainer.classList.add('hidden');
                    elements.dropOffError.classList.remove('hidden');
                }

                updateCustomSection();
                updateSeverityEvolutionSection(); // CALL NEW SECTION UPDATE

                // 6 Months Stats Logic
                if (windowSpeeds.length < 2) {
                    const na = "N/A", ins = "Dados insuficientes.";
                    elements.corrValue.textContent = na; elements.corrText.innerHTML = ins;
                    elements.zScoreValue.textContent = na; elements.zScoreText.innerHTML = ins;
                    elements.thermalValue.textContent = na; elements.thermalText.innerHTML = ins;
                    elements.geoValue.textContent = na; elements.geoText.innerHTML = ins;
                } else {
                    let r = calculatePearsonCorrelation(windowSpeeds, windowSeverities);
                    if (r < 0) r = 0;
                    elements.corrValue.textContent = r.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
                    let corrHTML = "";
                    if (r >= 0.7) corrHTML = `A velocidade tem uma correlação <span class="text-accent font-bold">forte</span> com a severidade`;
                    else if (r >= 0.5) corrHTML = `A velocidade tem uma correlação <span class="text-accent font-bold">moderada</span> com a severidade`;
                    else if (r >= 0.1) corrHTML = `A velocidade tem uma correlação <span class="text-accent font-bold">fraca</span> com a severidade`;
                    else corrHTML = `A velocidade tem uma correlação <span class="text-accent font-bold">desprezível</span> com a severidade`;
                    elements.corrText.innerHTML = corrHTML;

                    const siteMean = windowSeverities.reduce((a, b) => a + b) / windowSeverities.length;
                    const siteStdDev = calculateStandardDeviation(windowSeverities);
                    const zScore = siteStdDev > 0 ? (maxSeverityInWindow - siteMean) / siteStdDev : 0;
                    elements.zScoreValue.textContent = zScore.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
                    const isAnomaly = maxSeverityInWindow > (siteMean + 2 * siteStdDev);
                    let zScoreHTML = isAnomaly ? `Severidade acima do padrão do site para o trem <span class="text-accent font-bold">${maxSeverityVehicle}</span>` : `<span class="text-accent font-bold">Múltiplos veículos afetados</span>`;
                    elements.zScoreText.innerHTML = zScoreHTML;

                    if (!hasSevereImpacts) {
                        elements.thermalValue.textContent = "-"; elements.thermalText.innerHTML = "Nenhum impacto severo (>2000) registrado.";
                    } else {
                        let maxHourCount = -1, maxHour = -1;
                        for (let h = 0; h < 24; h++) { if (thermalHourCounts[h] > maxHourCount) { maxHourCount = thermalHourCounts[h]; maxHour = h; } }
                        elements.thermalValue.textContent = `${maxHour}h`;
                        let thermalHTML = "";
                        if (maxHour >= 10 && maxHour <= 16) thermalHTML = `Pico de impactos detectado no horário de <span class="text-accent font-bold">maior calor</span>.`;
                        else if (maxHour >= 22 || maxHour <= 5) thermalHTML = `Pico de impactos detectado no horário de <span class="text-accent font-bold">menor temperatura</span>.`;
                        else thermalHTML = `Pico de impactos em horário de temperatura neutra.`;
                        elements.thermalText.innerHTML = thermalHTML;
                    }

                    const occurrenceRate = totalEventsInWindow > 0 ? (uniqueVehiclesInWindow.size / totalEventsInWindow) : 0;
                    const occurrencePercent = (occurrenceRate * 100).toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + "%";
                    elements.geoValue.textContent = occurrencePercent;
                    let geoHTML = "";
                    if (occurrenceRate >= 0.4) geoHTML = `<span class="text-accent font-bold">Persistência Crítica</span>: ${occurrencePercent} dos trens sofreram impacto neste site.`;
                    else if (occurrenceRate < 0.4 && maxSeverityInWindow >= 2000) geoHTML = `Impactos severos isolados. <span class="text-accent font-bold">Baixa repetibilidade</span>.`;
                    else geoHTML = "Repetibilidade moderada sem severidade crítica.";
                    elements.geoText.innerHTML = geoHTML;
                }
            }
            
            showResults();
        }

        // Added back handleFile
        function handleFile() {
            const file = elements.input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) { processData(e.target.result); };
            reader.onerror = function() { showError("Erro ao ler o arquivo."); };
            reader.readAsText(file);
        }

        // Listeners
        elements.input.addEventListener('change', resetUI);
        elements.btn.addEventListener('click', handleFile);
        elements.startDateInput.addEventListener('change', updateCustomSection);
        elements.endDateInput.addEventListener('change', updateCustomSection);
        // New Listeners for Severity Section
        elements.sevStartDateInput.addEventListener('change', updateSeverityEvolutionSection);
        elements.sevEndDateInput.addEventListener('change', updateSeverityEvolutionSection);

    </script>
</body>
</html>